<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using optweight to Estimate Stable Balancing Weights • optweight</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using optweight to Estimate Stable Balancing Weights">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">optweight</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/optweight.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ngreifer/optweight/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using optweight to Estimate Stable Balancing Weights</h1>
                        <h4 data-toc-skip class="author">Noah
Greifer</h4>
            
            <h4 data-toc-skip class="date">2025-09-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ngreifer/optweight/blob/master/vignettes/optweight.Rmd" class="external-link"><code>vignettes/optweight.Rmd</code></a></small>
      <div class="d-none name"><code>optweight.Rmd</code></div>
    </div>

    
    
<style>
pre {
overflow-x: auto;
}
pre code {
word-wrap: normal;
white-space: pre;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>optweight</em> implements stable balancing weighting (SBW) as
described by <span class="citation">Zubizarreta (<a href="#ref-zubizarretaStableWeightsThat2015">2015</a>)</span>. This
involves estimating weights aimed at adjusting for confounding by
balancing covariates while minimizing some measure of variability of the
weights. SBW is also known as empirical balancing calibration weighting
<span class="citation">(<a href="#ref-chanGloballyEfficientNonparametric2016">Chan, Yam, and Zhang
2016</a>)</span> and entropy balancing <span class="citation">(<a href="#ref-kallbergLargeSampleProperties2023">Källberg and Waernbaum
2023</a>)</span>. These methods are related to inverse probability
weighting (IPW), and there are some equivalences between SBW and IPW
<span class="citation">(<a href="#ref-wangMinimalDispersionApproximately2020">Wang and Zubizarreta
2020</a>)</span>. While IPW typically involves fitting a propensity
score model for the probability of receiving treatment, SBW estimates
weights directly that balance the covariates. The distinction between
these two approaches is described in detail by <span class="citation">Chattopadhyay, Hase, and Zubizarreta (<a href="#ref-chattopadhyayBalancingVsModeling2020">2020</a>)</span>.</p>
<p>SBW involves solving the following optimization problem:</p>
<span class="math display">\[\begin{align}
\min_{\mathbf{w}} \quad &amp; f(\mathbf{w}, \mathbf{b},\mathbf{s}) \\
\text{s.t.} \quad &amp; \sum_{i:A_i=a} {s_i w_i} = \sum_{i:A_i=a} {s_i
b_i} \quad \forall a \in \mathcal{A} \\
&amp; \left| \frac{\sum_{i:A_i=a} {s_i w_i x_{k,i}}}{\sum_{i:A_i=a} {s_i
w_i}} - \bar{x}_k^* \right| \le \delta_k \quad \forall a \in
\mathcal{A}, \forall k \in \{1, \dots, K\} \\
&amp; w_i &gt; \varepsilon \quad \forall i
\end{align}\]</span>
<p>where <span class="math inline">\(\mathbf{w}=\{w_1, \dots,
w_N\}\)</span> are the estimated weights, <span class="math inline">\(\mathbf{s}=\{s_1, \dots, s_N\}\)</span> are
sampling weights, <span class="math inline">\(\mathbf{b}=\{b_1, \dots,
b_N\}\)</span> are “base” weights, <span class="math inline">\(A_i\)</span> is a categorical treatment taking on
values <span class="math inline">\(a \in \mathcal{A}\)</span>, <span class="math inline">\(x_{k,i}\)</span> and is the value of covariate
<span class="math inline">\(\mathbf{x}_k\)</span> for unit <span class="math inline">\(i\)</span>. <span class="math inline">\(f(\mathbf{w}, \mathbf{b},\mathbf{s})\)</span> is
the objective function to minimize, a function of the estimated weights,
base weights, and sampling weights. <span class="math inline">\(\delta_k\)</span> is the balance tolerance for
covariate <span class="math inline">\(k\)</span>, <span class="math inline">\(\bar{x}_k^*\)</span> is the target value for
covariate <span class="math inline">\(k\)</span>, and <span class="math inline">\(\varepsilon\)</span> is the minimum weight
allowed.</p>
<p>Generally, <span class="math inline">\(f\)</span> represents a
measure of dispersion from the base weights, weighted by the sampling
weights. The original formula of SBW used <span class="math inline">\(f(\mathbf{w}, \mathbf{b},\mathbf{s}) =
\frac{1}{N}\sum_i{s_i(w_i-b_i)^2}\)</span>, the weighted L2 norm.
Entropy balancing uses <span class="math inline">\(f(\mathbf{w},
\mathbf{b},\mathbf{s}) = \sum_i{s_i w_i
\log\left(\frac{w_i}{b_i}\right)}\)</span>, the weighted relative
entropy between the estimated and base weights.</p>
<p>The interpretation of these constraints is as follows:</p>
<ul>
<li><p>The first constraint is a scaling constraint that establishes a
meaningful scale for the weights. In particular, that scale is
determined by the base weights.</p></li>
<li><p>The second constraint is the balance constraint. A target value
can be chosen for each covariate, and the weighted mean of the
covariates in each treatment group must be within some tolerance of that
target. That also guarantees the weighted means between treatment groups
are within some tolerance of each other. It is possible to forgo a
specific target and just require the weighted means to be equal to each
other.</p></li>
<li><p>The final constraint is optional and restricts the minimum value
of the weights. For some <span class="math inline">\(f\)</span>, the
weights can be unbounded, and it is up to the user to require the
weights to fall within some range. The original formulation of SBW used
<span class="math inline">\(\varepsilon = 0\)</span>, but omitting this
constraint altogether, which allows the weights to be negative, is also
possible.</p></li>
</ul>
<p>Asymptotic properties of SBW are described in <span class="citation">Wang and Zubizarreta (<a href="#ref-wangMinimalDispersionApproximately2020">2020</a>)</span>. In
general, the weights are precise and perform well, and adding
approximate balance constraints (i.e., using <span class="math inline">\(\delta_k&gt;0\)</span>) tends to improve precision
without greatly affecting bias. There is also a weak double-robustness
property to the weights: the estimate is consistent if either the
outcome model corresponds to the balance constraints or the implicit
propensity score model corresponds to the true propensity score model.
Different forms of <span class="math inline">\(f\)</span> imply
different assumptions about the propensity score model. Allowing <span class="math inline">\(\varepsilon\)</span> to be negative allows for the
possibility of negative weights, which can improve precision but induce
extrapolation. It turns out that using a linear regression model for the
outcome is equivalent to using SBW with the L2 norm, <span class="math inline">\(\delta_k=0\)</span>, and <span class="math inline">\(\varepsilon=-\infty\)</span> <span class="citation">(<a href="#ref-chattopadhyayImpliedWeightsLinear2023">Chattopadhyay and
Zubizarreta 2023</a>)</span>.</p>
<p>Often <span class="math inline">\(\bar{x}_k^*\)</span> are chosen to
represent a known target group, like the full sample when targeting the
ATE or the treated group when targeting the ATT. They can also be chosen
to generalize the effect estimate to an arbitrary target population
<span class="citation">(<a href="#ref-chattopadhyayOneStepWeightingGeneralize2024">Chattopadhyay,
Cohn, and Zubizarreta 2024</a>)</span>.</p>
<p>SBWs can be generalized to continuous treatments, in which case
instead of balancing the covariate means, the treatment-covariate
covariances are constrained to be balanced. This was explored in <span class="citation">Greifer (<a href="#ref-greiferEstimatingBalancingWeights2020">2020</a>)</span>,
<span class="citation">Tübbicke (<a href="#ref-tubbickeEntropyBalancingContinuous2022">2022</a>)</span>, and
<span class="citation">Vegetabile et al. (<a href="#ref-vegetabileNonparametricEstimationPopulation2021">2021</a>)</span>.
SBW can also be used to directly weight a sample to resemble a
population, without needing to balance two treatment groups. This also
known known as matching-adjusted indirect comparison [MAIC; <span class="citation">Phillippo et al. (<a href="#ref-phillippoEquivalenceEntropyBalancing2020">2020</a>)</span>,
<span class="citation">Signorovitch et al. (<a href="#ref-signorovitchComparativeEffectivenessHeadtoHead2010">2010</a>)</span>].</p>
<p><em>optweight</em> contains functionality to perform these operations
and assess their performance. It was designed to be user-friendly,
compatible with the syntax used with <em>WeightIt</em>, and supported by
<em>cobalt</em> for balance assessment, at the possible expense of some
flexibility. The <em>sbw</em> package also implements some of these
methods, prioritizing different aspects of the estimation. Entropy
balancing is implemented in <em>WeightIt</em>, which also calls
<em>optweight</em> to provide a simpler interface to SBW.</p>
</div>
<div class="section level2">
<h2 id="using-optweight">Using <em>optweight</em><a class="anchor" aria-label="anchor" href="#using-optweight"></a>
</h2>
<p>The main function in <em>optweight</em> is <code><a href="../reference/optweight.html">optweight()</a></code>,
which uses a formula interface to specify the treatment, covariates, and
balance tolerance. Other functions in <em>optweight</em> simplify
specification of more detailed parameters and support diagnostics.</p>
<p>Below, we’ll use <code><a href="../reference/optweight.html">optweight()</a></code> to estimate weights that
balance the covariates in an observational study. We’ll use the
<code>lalonde</code> dataset in <em>cobalt</em> and target the ATT
first. The treatment is <code>treat</code>, the outcome is
<code>re78</code>, and the other variables are the covariates to
balance.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/optweight/">optweight</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">"cobalt"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   treat age educ   race married nodegree re74 re75    re78</span></span>
<span><span class="co">## 1     1  37   11  black       1        1    0    0  9930.0</span></span>
<span><span class="co">## 2     1  22    9 hispan       0        1    0    0  3595.9</span></span>
<span><span class="co">## 3     1  30   12  black       0        0    0    0 24909.5</span></span>
<span><span class="co">## 4     1  27   11  black       0        1    0    0  7506.1</span></span>
<span><span class="co">## 5     1  33    8  black       0        1    0    0   289.8</span></span>
<span><span class="co">## 6     1  22    9  black       0        1    0    0  4056.5</span></span></code></pre>
<p><code><a href="../reference/optweight.html">optweight()</a></code> can be used simply by supplying the
treatment can covariates to the <code>formula</code> argument, the
dataset to the <code>data</code> argument, and the estimand to the
<code>estimand</code> argument (here, the ATT). By default,
<code><a href="../reference/optweight.html">optweight()</a></code> minimizes the L2 norm, requires exact mean
balance on the covariates, and requires all weights to be greater than
<span class="math inline">\(10^{-8}\)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                  <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span><span class="va">ow</span></span></code></pre></div>
<pre><code><span><span class="co">## An optweight object</span></span>
<span><span class="co">##  - number of obs.: 614</span></span>
<span><span class="co">##  - norm minimized: "l2"</span></span>
<span><span class="co">##  - sampling weights: present</span></span>
<span><span class="co">##  - base weights: present</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATT (focal: 1)</span></span>
<span><span class="co">##  - covariates: age, educ, race, married, nodegree, re74, re75</span></span></code></pre>
<p>Using <code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">cobalt::bal.tab()</a></code> on the output computes the
weighted balance statistics.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">ow</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.Adj</span></span>
<span><span class="co">## age         Contin.       -0</span></span>
<span><span class="co">## educ        Contin.       -0</span></span>
<span><span class="co">## race_black   Binary       -0</span></span>
<span><span class="co">## race_hispan  Binary        0</span></span>
<span><span class="co">## race_white   Binary        0</span></span>
<span><span class="co">## married      Binary       -0</span></span>
<span><span class="co">## nodegree     Binary       -0</span></span>
<span><span class="co">## re74        Contin.       -0</span></span>
<span><span class="co">## re75        Contin.       -0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted   429.      185</span></span>
<span><span class="co">## Adjusted     108.6     185</span></span></code></pre>
<p>As expected, all mean differences are exactly 0 in the weighted
sample. We can use <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to examine some properties of
the weights:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Weight ranges:</span></span>
<span><span class="co">##         Min                                 Max</span></span>
<span><span class="co">## treated   1      ||                       1.   </span></span>
<span><span class="co">## control   0 |---------------------------| 6.002</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Units with 5 greatest weights by group:</span></span>
<span><span class="co">##                                            </span></span>
<span><span class="co">##               1      2      3      4      5</span></span>
<span><span class="co">##  treated      1      1      1      1      1</span></span>
<span><span class="co">##             423    388    226    196    118</span></span>
<span><span class="co">##  control 5.5685 5.6016 5.6698 5.9221 6.0023</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.       0.         0</span></span>
<span><span class="co">## control 1.717 1.339 5.002    1.23       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     108.6     185</span></span></code></pre>
<p><code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> produces some information about the
distribution of weights, including different measures of the dispersion
of the weights, each of which corresponds to one of the allowed
objective functions to minimize. <code>RMSE Dev</code> is the root mean
squared deviation of the estimated weights from the base weights (here,
the base weights are all 1). See <code><a href="../reference/summary.optweight.html">?summary.optweight</a></code> for
more information about the other statistics. Lastly,
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> produces the weighted and original (effective)
samples sizes.</p>
<p>We can use <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> on the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> output
to visualize the distribution of the weights:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="optweight_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Because we targeted the ATT, only the weights for the control group
are displayed (the treated group weights are all 1).</p>
<p>Below, we’ll adjust a few of the argument to see what affects they
have on the weights.</p>
<div class="section level3">
<h3 id="tols">
<code>tols</code><a class="anchor" aria-label="anchor" href="#tols"></a>
</h3>
<p>The balance tolerance is controlled by the <code>tols</code>
argument. This can either be a single value applied to all variables or
a vector with a value for each covariate. By default,
<code>tols = 0</code>. Let’s see what happens when we increase
<code>tols</code> to .02.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                   <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                 estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                 tols <span class="op">=</span> <span class="fl">.02</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">ow2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.Adj</span></span>
<span><span class="co">## age         Contin.     0.02</span></span>
<span><span class="co">## educ        Contin.     0.02</span></span>
<span><span class="co">## race_black   Binary     0.02</span></span>
<span><span class="co">## race_hispan  Binary     0.00</span></span>
<span><span class="co">## race_white   Binary    -0.02</span></span>
<span><span class="co">## married      Binary    -0.02</span></span>
<span><span class="co">## nodegree     Binary     0.02</span></span>
<span><span class="co">## re74        Contin.    -0.02</span></span>
<span><span class="co">## re75        Contin.     0.02</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted   429.      185</span></span>
<span><span class="co">## Adjusted     118.8     185</span></span></code></pre>
<p>Now, all mean differences are less than .02. Note that by default,
<code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">cobalt::bal.tab()</a></code> reports standardized mean differences for
continuous variables and raw mean differences for binary variables.
<code><a href="../reference/optweight.html">optweight()</a></code> standardizes the balance tolerances the same
way: by default, <code>tols</code> refers to the largest standardized
mean difference allowed for continuous variables and the largest raw
mean difference for binary variables. To change whether tolerances for
binary or continuous variables should be in standardized units or not,
see the <code>std.binary</code> and <code>std.cont</code> arguments of
<code><a href="../reference/optweight.fit.html">optweight.fit()</a></code>, which <code><a href="../reference/optweight.html">optweight()</a></code> calls under
the hood.</p>
<p>Allowing for more relaxed imbalance also increases the ESS. The RMSE
deviation has shrunk correspondingly:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow2</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.      0.          0</span></span>
<span><span class="co">## control 1.616 1.267 4.212   1.118       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     118.8     185</span></span></code></pre>
<p>To supply each covariate with its own tolerance, a named vector must
be supplied. This can sometimes be a little tedious, so there is a
helper function, <code><a href="../reference/process_tols.html">process_tols()</a></code>, that simplifies this. Give
<code><a href="../reference/process_tols.html">process_tols()</a></code> the formula and dataset (and, optionally, an
initial tolerance or vector), and it will return a modifiable vector of
balance tolerances that can be supplied to <code><a href="../reference/optweight.html">optweight()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_tols.html">process_tols</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                       <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                     tols <span class="op">=</span> <span class="fl">.02</span><span class="op">)</span></span>
<span><span class="va">tols</span></span></code></pre></div>
<pre><code><span><span class="co">## - tols:</span></span>
<span><span class="co">##      age     educ     race  married nodegree     re74     re75 </span></span>
<span><span class="co">##     0.02     0.02     0.02     0.02     0.02     0.02     0.02</span></span></code></pre>
<p>Here, we’ll relax the constraint on <code>race</code> and then
estimate the weights.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span><span class="op">[</span><span class="st">"race"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.07</span></span>
<span></span>
<span><span class="va">tols</span></span></code></pre></div>
<pre><code><span><span class="co">## - tols:</span></span>
<span><span class="co">##      age     educ     race  married nodegree     re74     re75 </span></span>
<span><span class="co">##     0.02     0.02     0.07     0.02     0.02     0.02     0.02</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                   <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                 estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                 tols <span class="op">=</span> <span class="va">tols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">ow3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.Adj</span></span>
<span><span class="co">## age         Contin.     0.02</span></span>
<span><span class="co">## educ        Contin.     0.02</span></span>
<span><span class="co">## race_black   Binary     0.07</span></span>
<span><span class="co">## race_hispan  Binary     0.00</span></span>
<span><span class="co">## race_white   Binary    -0.07</span></span>
<span><span class="co">## married      Binary    -0.02</span></span>
<span><span class="co">## nodegree     Binary     0.02</span></span>
<span><span class="co">## re74        Contin.    -0.02</span></span>
<span><span class="co">## re75        Contin.     0.02</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted   429.      185</span></span>
<span><span class="co">## Adjusted     132.7     185</span></span></code></pre>
<p>We can see that for all covariates other than <code>race</code>, the
mean differences are at or below .02, but for <code>race</code>, the
mean differences are at or below .07. This led to an increase in ESS due
to the relaxed constraints.</p>
</div>
<div class="section level3">
<h3 id="norm">
<code>norm</code><a class="anchor" aria-label="anchor" href="#norm"></a>
</h3>
<p>The <code>norm</code> argument controls which objective function is
used. The allowable arguments are <code>"l2"</code> for the L2 norm (the
default), <code>"l1"</code> for the L1 norm, <code>"linf"</code> for the
L<span class="math inline">\(\infty\)</span> norm,
<code>"entropy"</code> for the relative entropy, and <code>"log"</code>
for the sum of the negative logs. The most thorough theoretical work has
been done on the L2 norm and relative entropy, and these tend to be the
easiest to optimize.</p>
<p>Weighting by minimizing the relative entropy is also known as
“entropy balancing” <span class="citation">(<a href="#ref-hainmuellerEntropyBalancingCausal2012">Hainmueller 2012</a>;
<a href="#ref-kallbergLargeSampleProperties2023">Källberg and Waernbaum
2023</a>; <a href="#ref-zhaoEntropyBalancingDoubly2017">Zhao and
Percival 2017</a>)</span> and is available in <em>WeightIt</em>, which
uses a more parsimonious representation of the problem. Weighting by
minimizing the sum of negative logs is equivalent to nonparametric
covariate balancing propensity score (npCBPS) weighting <span class="citation">(<a href="#ref-fongCovariateBalancingPropensity2018">Fong, Hazlett, and Imai
2018</a>)</span>, which maximizes the empirical likelihood of the data
to estimate the weights. A penalized version of npCBPS is available in
<em>CBPS</em> and in <em>WeightIt</em> (which calls functions from
<em>CBPS</em>), but <em>optweight</em> offers additional options not
possible in those packages, such as specifying balance tolerances,
targets, and different estimands.</p>
<p>Different solvers are available for each norm; see
<code>?optweight.fit()</code> for details.</p>
<p>Below, we’ll minimize the L2 norm, L1 norm, L<span class="math inline">\(\infty\)</span> norm, and relative entropy and see
how those choices affect the properties of the weights.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># L2 norm</span></span>
<span><span class="va">ow_l2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                     <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                   norm <span class="op">=</span> <span class="st">"l2"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_l2</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.       0.         0</span></span>
<span><span class="co">## control 1.717 1.339 5.002    1.23       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     108.6     185</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># L1 norm</span></span>
<span><span class="va">ow_l1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                     <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                   norm <span class="op">=</span> <span class="st">"l1"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_l1</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.     0.     0.          0</span></span>
<span><span class="co">## control 2.082 1.281 10.83   1.239       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted  429.       185</span></span>
<span><span class="co">## Weighted     80.42     185</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># L-infinity norm</span></span>
<span><span class="va">ow_linf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                     <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                   norm <span class="op">=</span> <span class="st">"linf"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The optimization failed to find a solution after 2e+05 iterations. The problem may be infeasible or more iterations may be required. Check the dual variables to see which</span></span>
<span><span class="co">## constraints are likely causing this issue.</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_linf</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.        0.        0</span></span>
<span><span class="co">## control 1.877 1.549 3.578     1.5       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted  429.       185</span></span>
<span><span class="co">## Weighted     94.81     185</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Relative entropy</span></span>
<span><span class="va">ow_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                     <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                   norm <span class="op">=</span> <span class="st">"entropy"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_re</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1   L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.     0.          0</span></span>
<span><span class="co">## control 1.832 1.287 8.42   1.101       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted  429.       185</span></span>
<span><span class="co">## Weighted     98.46     185</span></span></code></pre>
<p>We can see that minimizing the L2 norm yields weights that have the
lowest RMS deviation, minimizing the L1 norm yields weights that have
the lowest mean absolute deviation, minimizing the L<span class="math inline">\(\infty\)</span> norm yields weights that have the
lowest maximum absolute deviation, and minimizing the relative entropy
yields weights that have the lowest relative entropy. The L2 norm has
the closest correspondence to the ESS (they have a 1:1 relationship),
but there are some theoretical reasons to prefer other norms, especially
when they correspond to certain assumptions about the true propensity
score model. See <span class="citation">Källberg and Waernbaum (<a href="#ref-kallbergLargeSampleProperties2023">2023</a>)</span> for more
information on these assumptions.</p>
</div>
<div class="section level3">
<h3 id="estimand-and-targets">
<code>estimand</code> and <code>targets</code><a class="anchor" aria-label="anchor" href="#estimand-and-targets"></a>
</h3>
<p>Different estimands can be targeted by supplying an argument to
<code>estimand</code>. Allowable estimands include the ATE, ATT, and
ATC. These ensure the covariate means in each group resemble those in
the full sample, the treated group, and the control group, respectively.
For example, if set <code>estimand = "ATE"</code>, both groups will be
weighted so that the covariate means are equal to the covariate means in
the full sample, as demonstrated below.</p>
<p>The covariate means in the full sample can be computed using
<code><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">cobalt::col_w_mean()</a></code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="va">lalonde</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">covs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<p>After estimating weights that target the ATE, we will see that the
weighted covariate means in each group are equal to those in the full
sample:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow_ate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                      <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                    estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">covs</span>, weights <span class="op">=</span> <span class="va">ow_ate</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                   subset <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">covs</span>, weights <span class="op">=</span> <span class="va">ow_ate</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                   subset <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<p>In addition to targeting a natural sample, it’s also possible to
target a specific population by supplying an argument to
<code>targets</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Indeed, using &lt;code&gt;estimand&lt;/code&gt; is just a shortcut
to using &lt;code&gt;targets&lt;/code&gt; when the target population is one of those
supported by &lt;code&gt;estimand&lt;/code&gt;.&lt;/p&gt;"><sup>1</sup></a>. The theory behind this methodology is
described by <span class="citation">Chattopadhyay, Cohn, and Zubizarreta
(<a href="#ref-chattopadhyayOneStepWeightingGeneralize2024">2024</a>)</span>.
To request a different target population, <code><a href="../reference/process_targets.html">process_targets()</a></code>
can be used to create a vector of target means which are supplied to the
<code>targets</code> argument of <code><a href="../reference/optweight.html">optweight()</a></code>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_targets.html">process_targets</a></span><span class="op">(</span><span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                             <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>,</span>
<span>                           data <span class="op">=</span> <span class="va">lalonde</span><span class="op">)</span></span>
<span></span>
<span><span class="va">targets</span></span></code></pre></div>
<pre><code><span><span class="co">## - targets:</span></span>
<span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<p>By default, <code><a href="../reference/process_targets.html">process_targets()</a></code> computes the mean of each
covariate in the full sample. These can be modified similarly to
<code>tols</code> to specify target means. Note that for categorical
covariates, the proportions in the groups must sum to 1.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targets</span><span class="op">[</span><span class="st">"age"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">35</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"race_black"</span>, <span class="st">"race_hispan"</span>, <span class="st">"race_white"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.3</span>, <span class="fl">.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">targets</span></span></code></pre></div>
<pre><code><span><span class="co">## - targets:</span></span>
<span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     35.0000     10.2687      0.5000      0.3000      0.2000      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<p>We can supply these to <code><a href="../reference/optweight.html">optweight()</a></code> to request that the
covariate means in the weighted sample are equal to these target means.
We need to set <code>estimand = NULL</code> to ensure the
<code>targets</code> are obeyed. Failing to do this will produce a
warning.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                         <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                       targets <span class="op">=</span> <span class="va">targets</span>,</span>
<span>                       estimand <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Weighted covariate means in the two groups</span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">covs</span>, weights <span class="op">=</span> <span class="va">ow_target</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                   subset <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     35.0000     10.2687      0.5000      0.3000      0.2000      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">covs</span>, weights <span class="op">=</span> <span class="va">ow_target</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                   subset <span class="op">=</span> <span class="va">lalonde</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75 </span></span>
<span><span class="co">##     35.0000     10.2687      0.5000      0.3000      0.2000      0.4153      0.6303   4557.5466   2184.9382</span></span></code></pre>
<p>The treatment effect estimate from this method of weighting would
have the interpretation of the estimate from a population with similar
means to those of the sample but with a mean age of 35 years (older than
the original sample) and a racial profile of 50% Black, 30% Hispanic,
and 20% white.</p>
<p>Note that <code><a href="../reference/process_targets.html">process_targets()</a></code> can be supplied without a
formula if targets are to be specified for all variables in
<code>data</code>. We’ll use this syntax in the section on
<code><a href="../reference/optweight.svy.html">optweight.svy()</a></code> below.</p>
</div>
<div class="section level3">
<h3 id="sampling-weights-and-base-weights">Sampling weights and base weights<a class="anchor" aria-label="anchor" href="#sampling-weights-and-base-weights"></a>
</h3>
<p>Sampling weights are used when attempting to generalize the estimates
from a sample to a specific target population. Some datasets come with
sampling weights in order for analyses using them to be valid. These
weights can be supplied to the <code>s.weights</code> argument of
<code><a href="../reference/optweight.html">optweight()</a></code>. This has three effects: 1) the balance and
target constraints correspond to the product of the estimated and
sampling weights, 2) the target values for the covariates are weighted
by the sampling weights (if not supplied through <code>targets</code>),
and 3) the contribution of the estimated weights to the objective
function is weighted by the sampling weights. Sampling weights are also
used when bootstrapping using the fractional weighted bootstrap <span class="citation">(<a href="#ref-xuApplicationsFractionalRandomWeightBootstrap2020a">Xu et al.
2020</a>)</span>, e.g., as implemented in the <em>fwb</em> package. By
default, when <code>s.weights</code> is not specified, sampling weights
are equal to 1.</p>
<p>Base weights are a set of initial weights that have some properties
that the user wants to retain while enforcing balance constraints. The
estimated weights are chosen to minimize their distance from the base
weights, where that distance corresponds to <span class="math inline">\(f\)</span>. These weights can be supplied to the
<code>b.weights</code> argument of <code><a href="../reference/optweight.html">optweight()</a></code>. By default,
when not specified, base weights are equal to 1. An example use of base
weights would be to enforce balance on a set of IPW weights estimated
using a flexible model that is unable to exactly balance the covariates.
This strategy was used by one of the winning methods in the 2016 ACIC
data competition <span class="citation">(<a href="#ref-dorieAutomatedDoityourselfMethods2019">Dorie et al.
2019</a>)</span>. We’ll demonstrate the use of base weights below.</p>
<p>First, we’ll estimate propensity score weights using generalized
boosted modeling through <em>WeightIt</em>. This is a flexible machine
learning model, and we can request that features beyond the covariate
means be balanced by minimizing the largest Kolmogorov-Smirnov (KS)
statistic in the weighted sample.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W_gbm</span> <span class="op">&lt;-</span> <span class="fu">WeightIt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                              <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                            estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                            method <span class="op">=</span> <span class="st">"gbm"</span>,</span>
<span>                            criterion <span class="op">=</span> <span class="st">"ks.max"</span><span class="op">)</span></span></code></pre></div>
<p>Next we’ll use <code><a href="../reference/optweight.html">optweight()</a></code> to estimate a set of weights
that differ as little as possible (as measured by the root mean squared
divergence) from these estimated weights while enforcing exact balance
on the covariate means.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow_bw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                     <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                   estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                   b.weights <span class="op">=</span> <span class="va">W_gbm</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<p>We’ll also estimate SBW weights with uniform base weights to see the
difference in the properties of the weights.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                  <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can look at balance on all three sets of weights on the
means and KS statistics.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mean diferences</span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W_gbm</span>, stats <span class="op">=</span> <span class="st">"m"</span>,</span>
<span>                weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ow_bw <span class="op">=</span> <span class="va">ow_bw</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                               ow <span class="op">=</span> <span class="va">ow</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                 Type Diff.weightit Diff.ow_bw Diff.ow</span></span>
<span><span class="co">## prop.score  Distance         0.395      0.382    1.13</span></span>
<span><span class="co">## age          Contin.        -0.033      0.000   -0.00</span></span>
<span><span class="co">## educ         Contin.        -0.061      0.000   -0.00</span></span>
<span><span class="co">## race_black    Binary         0.013      0.000   -0.00</span></span>
<span><span class="co">## race_hispan   Binary         0.006     -0.000    0.00</span></span>
<span><span class="co">## race_white    Binary        -0.019     -0.000    0.00</span></span>
<span><span class="co">## married       Binary        -0.022      0.000   -0.00</span></span>
<span><span class="co">## nodegree      Binary         0.086      0.000   -0.00</span></span>
<span><span class="co">## re74         Contin.         0.037      0.000   -0.00</span></span>
<span><span class="co">## re75         Contin.         0.069      0.000   -0.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##          Control Treated</span></span>
<span><span class="co">## All       429.       185</span></span>
<span><span class="co">## weightit   32.07     185</span></span>
<span><span class="co">## ow_bw      31.62     185</span></span>
<span><span class="co">## ow        108.64     185</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># KS statistics</span></span>
<span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W_gbm</span>, stats <span class="op">=</span> <span class="st">"ks"</span>,</span>
<span>                weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ow_bw <span class="op">=</span> <span class="va">ow_bw</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                               ow <span class="op">=</span> <span class="va">ow</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                 Type KS.weightit KS.ow_bw KS.ow</span></span>
<span><span class="co">## prop.score  Distance       0.189    0.183 0.488</span></span>
<span><span class="co">## age          Contin.       0.086    0.118 0.283</span></span>
<span><span class="co">## educ         Contin.       0.086    0.055 0.042</span></span>
<span><span class="co">## race_black    Binary       0.013    0.000 0.000</span></span>
<span><span class="co">## race_hispan   Binary       0.006    0.000 0.000</span></span>
<span><span class="co">## race_white    Binary       0.019    0.000 0.000</span></span>
<span><span class="co">## married       Binary       0.022    0.000 0.000</span></span>
<span><span class="co">## nodegree      Binary       0.086    0.000 0.000</span></span>
<span><span class="co">## re74         Contin.       0.045    0.041 0.226</span></span>
<span><span class="co">## re75         Contin.       0.072    0.051 0.140</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##          Control Treated</span></span>
<span><span class="co">## All       429.       185</span></span>
<span><span class="co">## weightit   32.07     185</span></span>
<span><span class="co">## ow_bw      31.62     185</span></span>
<span><span class="co">## ow        108.64     185</span></span></code></pre>
<p>Looking at the mean differences (in the columns
<code>Diff.weightit</code>, <code>Diff.ow_bw</code>, and
<code>Diff.ow</code> in the first stable), we can see that the GBM
weights from <em>WeightIt</em> alone did not balance the covariate
means, whereas both set of SBW weights from <em>optweight</em> did.
However, in the second table, we can see big differences in the KS
statistics between the SBW weights that incorporated the base weights
and those that didn’t. The KS statistics for the SBW weights that
incorporated the base weights (listed in the <code>KS.ow_bw</code>
column) are very close to those for the GBM weights (listed in the
<code>KS.weightit</code> column) because the estimated weights are very
close to the GBM weights. In contrast, the SBW weights that didn’t
incorporate the base weights have very high KS statistics for some
covariates (listed in the <code>KS.ow</code> column); they are unable to
take advantage of the distribution-balancing properties of the original
GBM weights.</p>
<p>In this way, incorporating the base weights provides a middle ground
between the GBM weights and the basic SBW weights: they ensure exact
balance on the means while attempting to retain as much similarity to
the GBM weights as possible, thereby inheriting some of their balancing
properties. Unfortunately, one of those properties is also a very low
ESS, though in this case, little ESS is lost by enforcing the additional
balance constraints. Using different norms with base weights can also be
more effective than using with them uniform base weights, as different
norms prioritize similarity to the base weights in ways that may retain
different properties<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note that base weights do not affect the estimated
weights when using &lt;code&gt;norm = "log"&lt;/code&gt;.&lt;/p&gt;'><sup>2</sup></a>.</p>
</div>
<div class="section level3">
<h3 id="dual-variables">Dual variables<a class="anchor" aria-label="anchor" href="#dual-variables"></a>
</h3>
<p>Dual variables, also known as “shadow prices”, are part of the output
of the optimization problem that represent how “active” a given
constraint is at the optimum <span class="citation">(<a href="#ref-zubizarretaStableWeightsThat2015">Zubizarreta
2015</a>)</span>. A large dual variable means that relaxing the
constraint will allow the objective function to reach a lower value.
They are related to the coefficients on covariates in a propensity score
model, representing how much each covariate is contributing to the
estimation of the weights. <span class="citation">Zubizarreta (<a href="#ref-zubizarretaStableWeightsThat2015">2015</a>)</span> describes
the utility of dual variables after SBW: they can be used to determine
which covariates can have constraints relaxed to improve precision and
which covariates can have constraints tightened without affecting
precision. The dual variables are available in <code><a href="../reference/optweight.html">optweight()</a></code>
output in the <code>duals</code> component, but they can also be plotted
using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>. They can also be useful for diagnosing
convergence failure; often, a constraint that is impossible to meet will
have a high dual variable when no solution can be found.</p>
<p>Below, we’ll demonstrate how we can use the dual variables to see how
to modify constraints to try to take advantage of the bias-variance
trade-off. First we’ll estimate SBW weights with tolerances of .02 for
all covariates.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_tols.html">process_tols</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                       <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                     tols <span class="op">=</span> <span class="fl">.02</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                  <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                tols <span class="op">=</span> <span class="va">tols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.      0.          0</span></span>
<span><span class="co">## control 1.616 1.267 4.212   1.118       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     118.8     185</span></span></code></pre>
<p>We can print the dual variables in the <code>duals</code> component
of the output object and plot them with <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow</span><span class="op">$</span><span class="va">duals</span></span></code></pre></div>
<pre><code><span><span class="co">##   constraint      cov    dual</span></span>
<span><span class="co">## 1     target      age 0.24485</span></span>
<span><span class="co">## 2     target     educ 0.62674</span></span>
<span><span class="co">## 3     target     race 5.66548</span></span>
<span><span class="co">## 4     target  married 1.05266</span></span>
<span><span class="co">## 5     target nodegree 1.61135</span></span>
<span><span class="co">## 6     target     re74 0.71501</span></span>
<span><span class="co">## 7     target     re75 0.04373</span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ow</span><span class="op">)</span></span></code></pre></div>
<p><img src="optweight_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>From this, it’s clear that <code>race</code> has the largest dual
variable, and <code>re75</code> has the smallest. That means we can
likely get the biggest gains in ESS by relaxing the constraint for
<code>race</code>, whereas tightening the constraint for
<code>re75</code> will have little effect on the ESS.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span><span class="op">[</span><span class="st">"race"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.1</span></span>
<span></span>
<span><span class="va">ow2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                   <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                 estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                 tols <span class="op">=</span> <span class="va">tols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow2</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.       0.         0</span></span>
<span><span class="co">## control 1.424 1.113 3.638    0.91       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     141.7     185</span></span></code></pre>
<p>By relaxing the constraint on <code>race</code>, our ESS increased by
quite a bit. We would not see the same increase had we instead relaxed
the constraint on a covariate with a smaller dual variable, like
<code>re75</code>:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.02</span></span>
<span><span class="va">tols</span><span class="op">[</span><span class="st">"re75"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.1</span></span>
<span></span>
<span><span class="va">ow3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                   <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                 estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                 tols <span class="op">=</span> <span class="va">tols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow3</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.      0.          0</span></span>
<span><span class="co">## control 1.616 1.267 4.207   1.118       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     118.8     185</span></span></code></pre>
<p>However, this also means we can tighten the constraint on
<code>re75</code> without much loss in ESS. Below, we decrease the
tolerance on <code>re75</code> to 0:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span><span class="op">[</span><span class="st">"re75"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">ow4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                   <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                 estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>                 tols <span class="op">=</span> <span class="va">tols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow4</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            L2    L1    L∞ Rel Ent # Zeros</span></span>
<span><span class="co">## treated 0.    0.    0.       0.         0</span></span>
<span><span class="co">## control 1.617 1.269 4.229    1.12       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted   429.      185</span></span>
<span><span class="co">## Weighted     118.7     185</span></span></code></pre>
<p>We see that despite the tighter tolerance, the ESS remains about the
same. For reference, below are the balance statistics and ESSs for all
four sets of weights:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                  <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ow  <span class="op">=</span> <span class="va">ow</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                               ow2 <span class="op">=</span> <span class="va">ow2</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                               ow3 <span class="op">=</span> <span class="va">ow3</span><span class="op">$</span><span class="va">weights</span>,</span>
<span>                               ow4 <span class="op">=</span> <span class="va">ow4</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.ow Diff.ow2 Diff.ow3 Diff.ow4</span></span>
<span><span class="co">## age         Contin.    0.02     0.02    0.020     0.02</span></span>
<span><span class="co">## educ        Contin.    0.02     0.02    0.020     0.02</span></span>
<span><span class="co">## race_black   Binary    0.02     0.10    0.020     0.02</span></span>
<span><span class="co">## race_hispan  Binary    0.00     0.00    0.000     0.00</span></span>
<span><span class="co">## race_white   Binary   -0.02    -0.10   -0.020    -0.02</span></span>
<span><span class="co">## married      Binary   -0.02    -0.02   -0.020    -0.02</span></span>
<span><span class="co">## nodegree     Binary    0.02     0.02    0.020     0.02</span></span>
<span><span class="co">## re74        Contin.   -0.02    -0.02   -0.020    -0.02</span></span>
<span><span class="co">## re75        Contin.    0.02     0.02    0.026    -0.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##     Control Treated</span></span>
<span><span class="co">## All   429.      185</span></span>
<span><span class="co">## ow    118.8     185</span></span>
<span><span class="co">## ow2   141.7     185</span></span>
<span><span class="co">## ow3   118.8     185</span></span>
<span><span class="co">## ow4   118.7     185</span></span></code></pre>
<p>Again we can see that relaxing the balance constraint for
<code>race</code> increases the ESS significantly, whereas either
tightening or relaxing the constraint for <code>re75</code> has little
effect on the ESS.</p>
</div>
<div class="section level3">
<h3 id="multivariate-treatments">Multivariate treatments<a class="anchor" aria-label="anchor" href="#multivariate-treatments"></a>
</h3>
<p>It is possible to supply balance constraints for multiple (i.e.,
multivariate) treatments simultaneously to estimate a single set of
weights that satisfies them all. This approach is described by <span class="citation">Chen and Zhou (<a href="#ref-chenCausalEffectEstimation2023">2023</a>)</span> in the
context of multiple continuous treatments. <code><a href="../reference/optweight.html">optweightMV()</a></code>
provides an interface to balancing multiple treatments and works
similarly to <code><a href="../reference/optweight.html">optweight()</a></code>, though with the ability to supply
multiple balancing formulas. Though this can be used with conceptually
distinct treatments, it can also sometimes be useful to use it with
multiple transformations of a single treatment; for example, <span class="citation">Greifer (<a href="#ref-greiferEstimatingBalancingWeights2020">2020</a>)</span> found
that in order to eliminate the bias due to certain kinds of imbalance
with a continuous treatment, the square of the centered treatment must
be uncorrelated with the covariates, in addition to the treatment itself
being uncorrelated with the covariates.</p>
<p>To use <code><a href="../reference/optweight.html">optweightMV()</a></code>, supply a list of balancing
formulas to the <code>formula.list</code> argument. The
<code>tols.list</code> argument must also be a list with a vector of
tolerances for each treatment, each with a value for each covariate.
However, <code>targets</code> should be a vector with a value for each
unique covariate since one cannot specify multiple targets for the same
covariate. Below is example (not run) of how to specify a call to
<code><a href="../reference/optweight.html">optweightMV()</a></code>:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">owmv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweightMV</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>                         <span class="va">t2</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>,</span>
<span>                         <span class="va">t3</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                    tols.list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">.01</span>, x2 <span class="op">=</span> <span class="fl">.01</span>, x3 <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">.02</span>, x2 <span class="op">=</span> <span class="fl">.02</span>, x3 <span class="op">=</span> <span class="fl">.02</span><span class="op">)</span>,</span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">.03</span>, x2 <span class="op">=</span> <span class="fl">.03</span>, x3 <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">10</span>, x2 <span class="op">=</span> <span class="fl">.34</span>, x3 <span class="op">=</span> <span class="fl">5.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The syntax can be abbreviated by supplying a single value in each
element of <code>tols.list</code> that is applied to all covariates,
e.g., <code>tols.list = list(.01, .02, .03)</code>; or, if the same
vector of balance tolerance is desired for all covariates for all
treatments, a list with a single vector, e.g.,
<code>tols.list = list(c(x1 = .01, x2 = .01, x3 = .01))</code>; or, if
the same tolerance is desired for all covariates and all treatments, a
list with a single value, e.g., <code>tols.list = list(.02)</code>.
<code>targets</code> can be omitted to target the ATE (i.e., to balance
the covariates at their means in the sample), but no other estimands can
be specified.</p>
<p>One might be tempted to use <code><a href="../reference/optweight.html">optweightMV()</a></code> to estimate
balancing weights for longitudinal treatments. While this is possible,
it’s not as simple as supplying a balancing formula for each treatment
balancing the treatment and covariate history to that treatment <span class="citation">(<a href="#ref-yiuJointCalibratedEstimation2020">Yiu
and Su 2020</a>)</span>. <span class="citation">Zhou and Wodtke (<a href="#ref-zhouResidualBalancingMethod2020">2020</a>)</span> describe
how to specify balance constraints for entropy balancing with
longitudinal treatments, and they involve balancing not the covariate
directly but rather the residuals in regressions of the covariates on
treatment and covariate histories. Functionality for this specific
method is not present in <em>optweight</em>, but is available in the
<em>rbw</em> package. It may be possible to implement this in
<em>optweight</em> manually, but I cannot advise on how to do so.</p>
</div>
<div class="section level3">
<h3 id="optweight-svy">
<code>optweight.svy()</code><a class="anchor" aria-label="anchor" href="#optweight-svy"></a>
</h3>
<p>When the goal is not to balance treatment groups to each other or to
some target population but rather to balance one sample to a target
distribution, one can use <code><a href="../reference/optweight.svy.html">optweight.svy()</a></code> instead of
<code><a href="../reference/optweight.html">optweight()</a></code>. The <code>.svy</code> suffix is an indication
that can be used as a method to generate survey weights so that the
sample generalizes to a population of interest with specific means.
<code><a href="../reference/optweight.svy.html">optweight.svy()</a></code> works just like <code><a href="../reference/optweight.html">optweight()</a></code>
except that no treatment variable is specified and <code>targets</code>
should be specified.</p>
<p>This is useful in the context of matching-adjusted indirect
comparison [MAIC; <span class="citation">Signorovitch et al. (<a href="#ref-signorovitchComparativeEffectivenessHeadtoHead2010">2010</a>)</span>],
which involves weighting a given trial sample to resemble the covariate
distribution of some other trial’s sample. MAIC as originally described
is equivalent to entropy balancing <span class="citation">(<a href="#ref-phillippoEquivalenceEntropyBalancing2020">Phillippo et al.
2020</a>)</span>, which can be requested by setting
<code>norm = "entropy"</code>.</p>
<p>Below, we demonstrate weighting the control subset of
<code>lalonde</code> to resemble a specific target population. As with
<code>optweightit()</code>, it can be helpful to use
<code><a href="../reference/process_targets.html">process_targets()</a></code> to simplify specification of the
covariates means. If all variables in the dataset are to be specified,
the formula can be omitted (for both <code><a href="../reference/process_targets.html">process_targets()</a></code> and
<code><a href="../reference/optweight.svy.html">optweight.svy()</a></code>).</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lalonde_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">lalonde</span>, <span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                    select <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_targets.html">process_targets</a></span><span class="op">(</span><span class="va">lalonde_c</span><span class="op">)</span></span>
<span></span>
<span><span class="va">targets</span></span></code></pre></div>
<pre><code><span><span class="co">## - targets:</span></span>
<span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75        re78 </span></span>
<span><span class="co">##     28.0303     10.2354      0.2028      0.1422      0.6550      0.5128      0.5967   5619.2365   2466.4844   6984.1697</span></span></code></pre>
<p>To request individual means, the targets can be set to those values.
To allow a covariate mean to vary freely, one can either omit it from
the calls to <code><a href="../reference/process_targets.html">process_targets()</a></code> and
<code><a href="../reference/optweight.svy.html">optweight.svy()</a></code> or set the target value to <code>NA</code>.
We’ll do that for <code>re78</code>, and set specific targets for the
other variables except <code>re75</code>, which we’ll leave at its
mean.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targets</span><span class="op">[</span><span class="st">"age"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">40</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="st">"educ"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">9</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"race_black"</span>, <span class="st">"race_hispan"</span>, <span class="st">"race_white"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.2</span>, <span class="fl">.6</span><span class="op">)</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="st">"married"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.6</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="st">"nodegree"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.6</span></span>
<span><span class="va">targets</span><span class="op">[</span><span class="st">"re74"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">targets</span><span class="op">[</span><span class="st">"re78"</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="va">targets</span></span></code></pre></div>
<pre><code><span><span class="co">## - targets:</span></span>
<span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75        re78 </span></span>
<span><span class="co">##        40.0         9.0         0.2         0.2         0.6         0.6         0.6      1000.0      2466.5          NA</span></span></code></pre>
<p>We can supply these to <code><a href="../reference/optweight.svy.html">optweight.svy()</a></code>. This time we’ll
set <code>min.w</code> to 0 to allow those with weights of 0 to be
effectively dropped from the sample.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.svy.html">optweight.svy</a></span><span class="op">(</span><span class="va">lalonde_c</span>,</span>
<span>                      targets <span class="op">=</span> <span class="va">targets</span>,</span>
<span>                      min.w <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ow_s</span></span></code></pre></div>
<pre><code><span><span class="co">## An optweight.svy object</span></span>
<span><span class="co">##  - number of obs.: 429</span></span>
<span><span class="co">##  - norm minimized: "l2"</span></span>
<span><span class="co">##  - sampling weights: present</span></span>
<span><span class="co">##  - base weights: present</span></span>
<span><span class="co">##  - covariates: age, educ, race, married, nodegree, re74, re75, re78</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Weight ranges:</span></span>
<span><span class="co">##     Min                                 Max</span></span>
<span><span class="co">## all   0 |---------------------------| 13.54</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Units with 5 greatest weights by group:</span></span>
<span><span class="co">##                                          </span></span>
<span><span class="co">##         404   152     111      19      16</span></span>
<span><span class="co">##  all 9.4881 9.669 11.3265 11.4289 13.5373</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##        L2  L1    L∞ # Zeros</span></span>
<span><span class="co">## all 2.237 1.5 12.54     307</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##             Total</span></span>
<span><span class="co">## Unweighted 429.  </span></span>
<span><span class="co">## Weighted    71.44</span></span></code></pre>
<p>We can see that the weights required to move the sample toward our
specified target decrease the ESS by quite a bit, and several units were
given weights of 0. This can actually be a good thing if it means less
data needs to be collected since those with weights of 0 are not
necessary for subsequent analysis. We can examine the weighted covariate
means using <code>cobalt::col_w_means()</code> as before, with the
estimated weights supplied to <code>s.weights</code>:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">lalonde_c</span>, s.weights <span class="op">=</span> <span class="va">ow_s</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75        re78 </span></span>
<span><span class="co">##        40.0         9.0         0.2         0.2         0.6         0.6         0.6      1000.0      2466.5      4725.6</span></span></code></pre>
<p>We can see that the weighted mean of <code>re78</code> is whatever
minimized the L2 norm of the weights since no constraint was placed on
it. As with <code><a href="../reference/optweight.html">optweight()</a></code>, we can see how much each
constraint contributed to the increase in variability by examining the
dual variables:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ow_s</span><span class="op">)</span></span></code></pre></div>
<p><img src="optweight_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<p>Here it’s clear that the constraint on <code>re74</code> is
contributing the most, and that relaxing the constraint would have the
greatest impact on ESS. The constraint can be relaxed either by changing
the target to one closer to that of the original data (or closer to
where it would be if no constraint was placed on <code>re74</code>) or
by setting a more relaxed tolerance for <code>re74</code> using
<code>tols</code>. We’ll use the latter option below:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tols</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_tols.html">process_tols</a></span><span class="op">(</span><span class="va">lalonde_c</span>, tols <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tols</span><span class="op">[</span><span class="st">"re74"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span></span>
<span><span class="va">tols</span></span></code></pre></div>
<pre><code><span><span class="co">## - tols:</span></span>
<span><span class="co">##      age     educ     race  married nodegree     re74     re75     re78 </span></span>
<span><span class="co">##        0        0        0        0        0      300        0        0</span></span></code></pre>
<p>Here we set the tolerance for <code>re74</code> to be 300. We need to
set <code>std.cont = FALSE</code> to tell <code><a href="../reference/optweight.svy.html">optweight.svy()</a></code>
that the tolerance for continuous variables should be in raw units, not
standardized units. Now we can interpret our constraint as allowing the
weighted mean for <code>re74</code> to be within 300 of its specified
target of 1000.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow_s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.svy.html">optweight.svy</a></span><span class="op">(</span><span class="va">lalonde_c</span>,</span>
<span>                       targets <span class="op">=</span> <span class="va">targets</span>,</span>
<span>                       min.w <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                       tols <span class="op">=</span> <span class="va">tols</span>,</span>
<span>                       std.cont <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ow_s2</span>, weight.range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of weights:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##       L2   L1    L∞ # Zeros</span></span>
<span><span class="co">## all 2.07 1.44 10.68     290</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - Effective Sample Sizes:</span></span>
<span><span class="co">##             Total</span></span>
<span><span class="co">## Unweighted 429.  </span></span>
<span><span class="co">## Weighted    81.15</span></span></code></pre>
<p>This increased the ESS of the weights, and below we can see that the
weighted mean for <code>re74</code> is at most 300 away from 1000, while
the other variables are at their specified targets.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cobalt</span><span class="fu">::</span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/balance-summary.html" class="external-link">col_w_mean</a></span><span class="op">(</span><span class="va">lalonde_c</span>, s.weights <span class="op">=</span> <span class="va">ow_s2</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age        educ  race_black race_hispan  race_white     married    nodegree        re74        re75        re78 </span></span>
<span><span class="co">##        40.0         9.0         0.2         0.2         0.6         0.6         0.6      1300.0      2466.5      4710.8</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="estimating-effects">Estimating effects<a class="anchor" aria-label="anchor" href="#estimating-effects"></a>
</h2>
<p>Because SBW weights function just like IPW weights, the same
procedures can be used to estimate the effect of treatment in an
SBW-weighted sample. One only needs to run a regression of the outcome
on the treatment with the weights incorporated. It is critical that the
usual standard errors from <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>,
etc., are not used; special standard errors are required after
weighting. See
<code><a href="https://ngreifer.github.io/WeightIt/articles/estimating-effects.html" class="external-link">vignette("estimating-effects", package = "WeightIt")</a></code> for
more details on estimating effects after weighting. <em>WeightIt</em>
provides tools for facilitating this when weights are estimated using
<code><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">WeightIt::weightit()</a></code>, which provides an interface to
<code><a href="../reference/optweight.html">optweight()</a></code>, though with slightly fewer options
available.</p>
<p>Often, the best way to account for uncertainty in estimating a
treatment effect after SBW is by bootstrapping. This ensures variability
due to estimating the weights is correctly incorporated. The fractional
weighted bootstrap is often particularly effective because no units are
dropped from the sample in each bootstrap replication. When
bootstrapping cannot be used (e.g., because it is too computationally
demanding or the specified constraints cannot be expected to be
satisfied in all bootstrap samples), using a robust standard error can
be an acceptable alternative.</p>
<p>Below, we demonstrate both approaches with the <code>lalonde</code>
data. First, we estimate the weights for the ATT and fit the outcome
model.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optweight.html">optweight</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span></span>
<span>                  <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>                estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span>          weights <span class="op">=</span> <span class="va">ow</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (Intercept)       treat </span></span>
<span><span class="co">##        5145        1204</span></span></code></pre>
<p>Again, we must not use the usual standard errors produced by running
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> on the <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> output; we must use
either bootstrapping or a robust standard error. First, we’ll use
bootstrapping with <em>fwb</em>, which implements the fractional
weighted bootstrap. This involves drawing a set of weights from a
distribution and performing the entire analysis with these weights
incorporated. These weights should be supplied to the
<code>s.weights</code> argument in <code><a href="../reference/optweight.html">optweight()</a></code> and
multiplied by the returned weights before being used in
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;When sampling weights are used with
&lt;code&gt;&lt;a href="../reference/optweight.html"&gt;optweight()&lt;/a&gt;&lt;/code&gt;, they should first be multiplied by the
bootstrap weights.&lt;/p&gt;'><sup>3</sup></a>. We can use <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> to
re-estimate the SBW weights and weighted regression model in each
bootstrap replication.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/fwb/" class="external-link">fwb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">bootfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">w</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ow_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">ow</span>, s.weights <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span>  <span class="va">fit_boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit</span>, weights <span class="op">=</span> <span class="va">ow_boot</span><span class="op">$</span><span class="va">weights</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_boot</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/fwb/reference/fwb.html" class="external-link">fwb</a></span><span class="op">(</span><span class="va">lalonde</span>, <span class="va">bootfun</span>,</span>
<span>            R <span class="op">=</span> <span class="fl">250</span>, <span class="co"># more is always better, but slower</span></span>
<span>            verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The optimization failed to find a stable solution.</span></span>
<span><span class="co">## The optimization failed to find a stable solution.</span></span>
<span><span class="co">## The optimization failed to find a stable solution.</span></span>
<span><span class="co">## The optimization failed to find a stable solution.</span></span></code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">boot</span>, ci.type <span class="op">=</span> <span class="st">"wald"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             Estimate Std. Error CI 2.5 % CI 97.5 %</span></span>
<span><span class="co">## (Intercept)     5145        624     3923      6367</span></span>
<span><span class="co">## treat           1204        804     -372      2781</span></span></code></pre>
<p>To use a robust standard error, it’s easiest to use functions in the
<em>marginaleffects</em> package. Supply the output of <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
to <code><a href="https://marginaleffects.com/man/r/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code> with
<code>vcov = "HC3"</code> to request a robust standard error for the
treatment effect estimate.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/" class="external-link">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://marginaleffects.com/man/r/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"treat"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %</span></span>
<span><span class="co">##      1204        824 1.46    0.144 2.8  -411   2819</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Term: treat</span></span>
<span><span class="co">## Type: response</span></span>
<span><span class="co">## Comparison: 1 - 0</span></span></code></pre>
<p>Robust standard errors treat the weights as fixed, which often yields
larger standard errors than the bootstrap.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-chanGloballyEfficientNonparametric2016" class="csl-entry">
Chan, Kwun Chuen Gary, Sheung Chi Phillip Yam, and Zheng Zhang. 2016.
<span>“Globally Efficient Non-Parametric Inference of Average Treatment
Effects by Empirical Balancing Calibration Weighting.”</span>
<em>Journal of the Royal Statistical Society: Series B (Statistical
Methodology)</em> 78 (3): 673–700. <a href="https://doi.org/10.1111/rssb.12129" class="external-link">https://doi.org/10.1111/rssb.12129</a>.
</div>
<div id="ref-chattopadhyayOneStepWeightingGeneralize2024" class="csl-entry">
Chattopadhyay, Ambarish, Eric R. Cohn, and José R. Zubizarreta. 2024.
<span>“One-Step Weighting to Generalize and Transport Treatment Effect
Estimates to a Target Population.”</span> <em>The American
Statistician</em> 78 (3): 280–89. <a href="https://doi.org/10.1080/00031305.2023.2267598" class="external-link">https://doi.org/10.1080/00031305.2023.2267598</a>.
</div>
<div id="ref-chattopadhyayBalancingVsModeling2020" class="csl-entry">
Chattopadhyay, Ambarish, Christopher H. Hase, and José R. Zubizarreta.
2020. <span>“Balancing Vs Modeling Approaches to Weighting in
Practice.”</span> <em>Statistics in Medicine</em> 39 (24): 3227–54. <a href="https://doi.org/10.1002/sim.8659" class="external-link">https://doi.org/10.1002/sim.8659</a>.
</div>
<div id="ref-chattopadhyayImpliedWeightsLinear2023" class="csl-entry">
Chattopadhyay, Ambarish, and José R Zubizarreta. 2023. <span>“On the
Implied Weights of Linear Regression for Causal Inference.”</span>
<em>Biometrika</em> 110 (3): 615–29. <a href="https://doi.org/10.1093/biomet/asac058" class="external-link">https://doi.org/10.1093/biomet/asac058</a>.
</div>
<div id="ref-chenCausalEffectEstimation2023" class="csl-entry">
Chen, Juan, and Yingchun Zhou. 2023. <span>“Causal Effect Estimation for
Multivariate Continuous Treatments.”</span> <em>Biometrical Journal</em>
65 (5): 2200122. <a href="https://doi.org/10.1002/bimj.202200122" class="external-link">https://doi.org/10.1002/bimj.202200122</a>.
</div>
<div id="ref-dorieAutomatedDoityourselfMethods2019" class="csl-entry">
Dorie, Vincent, Jennifer Hill, Uri Shalit, Marc Scott, and Dan Cervone.
2019. <span>“Automated Versus Do-It-Yourself Methods for Causal
Inference: Lessons Learned from a Data Analysis Competition.”</span>
<em>Statistical Science</em> 34 (1): 43–68. <a href="https://doi.org/10.1214/18-STS667" class="external-link">https://doi.org/10.1214/18-STS667</a>.
</div>
<div id="ref-fongCovariateBalancingPropensity2018" class="csl-entry">
Fong, Christian, Chad Hazlett, and Kosuke Imai. 2018. <span>“Covariate
Balancing Propensity Score for a Continuous Treatment: Application to
the Efficacy of Political Advertisements.”</span> <em>The Annals of
Applied Statistics</em> 12 (1): 156–77. <a href="https://doi.org/10.1214/17-AOAS1101" class="external-link">https://doi.org/10.1214/17-AOAS1101</a>.
</div>
<div id="ref-greiferEstimatingBalancingWeights2020" class="csl-entry">
Greifer, Noah. 2020. <span>“Estimating Balancing Weights for Continuous
Treatments Using Constrained Optimization.”</span> PhD thesis. <a href="https://doi.org/10.17615/DYSS-B342" class="external-link">https://doi.org/10.17615/DYSS-B342</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects: A
Multivariate Reweighting Method to Produce Balanced Samples in
Observational Studies.”</span> <em>Political Analysis</em> 20 (1):
25–46. <a href="https://doi.org/10.1093/pan/mpr025" class="external-link">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-kallbergLargeSampleProperties2023" class="csl-entry">
Källberg, David, and Ingeborg Waernbaum. 2023. <span>“Large Sample
Properties of Entropy Balancing Estimators of Average Causal
Effects.”</span> <em>Econometrics and Statistics</em>, November. <a href="https://doi.org/10.1016/j.ecosta.2023.11.004" class="external-link">https://doi.org/10.1016/j.ecosta.2023.11.004</a>.
</div>
<div id="ref-phillippoEquivalenceEntropyBalancing2020" class="csl-entry">
Phillippo, David M., Sofia Dias, A. E. Ades, and Nicky J. Welton. 2020.
<span>“Equivalence of Entropy Balancing and the Method of Moments for
Matching<span>-</span>Adjusted Indirect Comparison.”</span> <em>Research
Synthesis Methods</em> 11 (4): 568–72. <a href="https://doi.org/10.1002/jrsm.1416" class="external-link">https://doi.org/10.1002/jrsm.1416</a>.
</div>
<div id="ref-signorovitchComparativeEffectivenessHeadtoHead2010" class="csl-entry">
Signorovitch, James E., Eric Q. Wu, Andrew P. Yu, Charles M. Gerrits,
Evan Kantor, Yanjun Bao, Shiraz R. Gupta, and Parvez M. Mulani. 2010.
<span>“Comparative Effectiveness Without Head-to-Head Trials: A Method
for Matching-Adjusted Indirect Comparisons Applied to Psoriasis
Treatment with Adalimumab or Etanercept.”</span>
<em>PharmacoEconomics</em> 28 (10): 935–45. <a href="https://doi.org/10.2165/11538370-000000000-00000" class="external-link">https://doi.org/10.2165/11538370-000000000-00000</a>.
</div>
<div id="ref-tubbickeEntropyBalancingContinuous2022" class="csl-entry">
Tübbicke, Stefan. 2022. <span>“Entropy Balancing for Continuous
Treatments.”</span> <em>Journal of Econometric Methods</em> 11 (1):
71–89. <a href="https://doi.org/10.1515/jem-2021-0002" class="external-link">https://doi.org/10.1515/jem-2021-0002</a>.
</div>
<div id="ref-vegetabileNonparametricEstimationPopulation2021" class="csl-entry">
Vegetabile, Brian G., Beth Ann Griffin, Donna L. Coffman, Matthew
Cefalu, Michael W. Robbins, and Daniel F. McCaffrey. 2021.
<span>“Nonparametric Estimation of Population Average Dose-Response
Curves Using Entropy Balancing Weights for Continuous Exposures.”</span>
<em>Health Services and Outcomes Research Methodology</em> 21 (1):
69–110. <a href="https://doi.org/10.1007/s10742-020-00236-2" class="external-link">https://doi.org/10.1007/s10742-020-00236-2</a>.
</div>
<div id="ref-wangMinimalDispersionApproximately2020" class="csl-entry">
Wang, Yixin, and Jose R. Zubizarreta. 2020. <span>“Minimal Dispersion
Approximately Balancing Weights: Asymptotic Properties and Practical
Considerations.”</span> <em>Biometrika</em> 107 (1): 93–105. <a href="https://doi.org/10.1093/biomet/asz050" class="external-link">https://doi.org/10.1093/biomet/asz050</a>.
</div>
<div id="ref-xuApplicationsFractionalRandomWeightBootstrap2020a" class="csl-entry">
Xu, Li, Chris Gotwalt, Yili Hong, Caleb B. King, and William Q. Meeker.
2020. <span>“Applications of the Fractional-Random-Weight
Bootstrap.”</span> <em>The American Statistician</em> 74 (4): 345–58. <a href="https://doi.org/10.1080/00031305.2020.1731599" class="external-link">https://doi.org/10.1080/00031305.2020.1731599</a>.
</div>
<div id="ref-yiuJointCalibratedEstimation2020" class="csl-entry">
Yiu, Sean, and Li Su. 2020. <span>“Joint Calibrated Estimation of
Inverse Probability of Treatment and Censoring Weights for Marginal
Structural Models.”</span> <em>Biometrics</em> n/a (n/a).
https://doi.org/<a href="https://doi.org/10.1111/biom.13411" class="external-link">https://doi.org/10.1111/biom.13411</a>.
</div>
<div id="ref-zhaoEntropyBalancingDoubly2017" class="csl-entry">
Zhao, Qingyuan, and Daniel Percival. 2017. <span>“Entropy Balancing Is
Doubly Robust.”</span> <em>Journal of Causal Inference</em> 5 (1). <a href="https://doi.org/10.1515/jci-2016-0010" class="external-link">https://doi.org/10.1515/jci-2016-0010</a>.
</div>
<div id="ref-zhouResidualBalancingMethod2020" class="csl-entry">
Zhou, Xiang, and Geoffrey T. Wodtke. 2020. <span>“Residual Balancing: A
Method of Constructing Weights for Marginal Structural Models.”</span>
<em>Political Analysis</em> 28 (4): 487–506. <a href="https://doi.org/10.1017/pan.2020.2" class="external-link">https://doi.org/10.1017/pan.2020.2</a>.
</div>
<div id="ref-zubizarretaStableWeightsThat2015" class="csl-entry">
Zubizarreta, José R. 2015. <span>“Stable Weights That Balance Covariates
for Estimation with Incomplete Outcome Data.”</span> <em>Journal of the
American Statistical Association</em> 110 (511): 910–22. <a href="https://doi.org/10.1080/01621459.2015.1023805" class="external-link">https://doi.org/10.1080/01621459.2015.1023805</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
