[{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Using optweight to Estimate Stable Balancing Weights","text":"optweight implements stable balancing weighting (SBW) described Zubizarreta (2015) Y. Wang Zubizarreta (2020). involves estimating weights aimed adjusting confounding balancing covariates minimizing measure variability weights. SBW also known empirical balancing calibration weighting (Chan, Yam, Zhang 2016) entropy balancing (Källberg Waernbaum 2023). methods related inverse probability weighting (IPW), equivalences SBW IPW (Y. Wang Zubizarreta 2020). IPW typically involves fitting propensity score model probability receiving treatment, SBW estimates weights directly balance covariates. distinction two approaches described detail Chattopadhyay, Hase, Zubizarreta (2020). SBW involves solving following optimization problem: \\(\\mathbf{w}=\\{w_1, \\dots, w_n\\}\\) estimated weights \\(\\mathbf{s}=\\{s_1, \\dots, s_n\\}\\) sampling weights \\(\\mathbf{b}=\\{b_1, \\dots, b_n\\}\\) “base” weights \\(f(\\mathbf{w}, \\mathbf{b}, \\mathbf{s})\\) objective function minimize—function estimated weights, base weights, sampling weights \\(A_i\\) categorical treatment unit \\(\\) taking values \\(\\\\mathcal{}\\) \\(\\bar{x}^{sw}_{k,}\\) weighted mean covariate \\(x_k\\) treatment group \\(\\), weighted using product \\(\\mathbf{s}\\) \\(\\mathbf{w}\\) (.e., \\(\\bar{x}^{sw}_{k,} = \\frac{\\sum_{:A_i=} s_i w_i x_{ki}}{\\sum_{:A_i=} s_i w_i}\\), \\(x_{ki}\\) value covariate \\(\\mathbf{x}_k\\) unit \\(\\)) \\(\\delta_k\\) group balance tolerance covariate \\(k\\) \\(\\varepsilon_k\\) target balance tolerance covariate \\(k\\) \\(\\bar{x}_k^*\\) target value covariate \\(k\\) \\(w_\\text{min}\\) minimum weight allowed. interpretation constraints follows: Group Balance. weighted covariate means similar groups (tolerance \\(\\delta_k\\)). Target Balance. midpoints weighted covariate means pairs groups similar target values (tolerance \\(\\varepsilon_k\\)). Weight Range. weights larger \\(w_\\text{min}\\). Weight Scale. weights sum fixed value group. given dataset including treatment, covariates, sampling weights (may 1 none present), base weights (may 1 none present), user chooses \\(\\delta_k\\), \\(\\bar{x}_k^*\\), \\(\\varepsilon_k\\), \\(w_\\text{min}\\), \\(f\\). Generally, \\(f\\) represents measure dispersion base weights, weighted sampling weights; see section norm . Asymptotic properties SBW described Y. Wang Zubizarreta (2020), though formulation optweight differs slightly original formulation Y. Wang Zubizarreta (2020) allowing additional tuning parameter, \\(\\varepsilon_k\\), control target balance separately group balance. general, weights precise perform well, adding approximate balance constraints (.e., using \\(\\delta_k>0\\)) tends improve precision without greatly affecting bias. also weak double-robustness property weights: estimate consistent either outcome model corresponds balance constraints implicit propensity score model corresponds true propensity score model. Different forms \\(f\\) imply different assumptions propensity score model. Allowing \\(w_\\text{min}\\) negative allows possibility negative weights, can improve precision induce extrapolation. turns using linear regression model outcome equivalent using SBW \\(L_2\\) norm, \\(\\delta_k=0\\), \\(\\varepsilon_k=0\\), \\(w_\\text{min}=-\\infty\\) (Chattopadhyay Zubizarreta 2023). Often \\(\\bar{x}_k^*\\) chosen represent known target group, like full sample targeting ATE treated group targeting ATT. can also chosen generalize effect estimate arbitrary target population (Chattopadhyay, Cohn, Zubizarreta 2024) removed entirely prioritize group balance target balance (Barnard, Huling, Wolfson 2025). SBW can generalized continuous treatments, case instead balancing covariate means, treatment-covariate covariances constrained balanced. explored Greifer (2020), Tübbicke (2022), Vegetabile et al. (2021). SBW can also used directly weight sample resemble population, without needing balance two treatment groups. also known known matching-adjusted indirect comparison Signorovitch et al. (2010). optweight contains functionality perform operations assess performance. designed user-friendly, compatible syntax used WeightIt, supported cobalt balance assessment, possible expense flexibility. sbw package also implements methods, prioritizing different aspects estimation. Entropy balancing also implemented WeightIt, can also call optweight provide simpler interface SBW.","code":""},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"using-optweight","dir":"Articles","previous_headings":"","what":"Using optweight","title":"Using optweight to Estimate Stable Balancing Weights","text":"main function optweight optweight(), uses formula interface specify treatment, covariates, balance tolerance. functions optweight facilitate specification detailed parameters support diagnostics. , ’ll use optweight() estimate weights balance covariates observational study. ’ll use lalonde dataset cobalt target ATT first. treatment treat, outcome re78, variables covariates balance. optweight() can used simply supplying treatment covariates formula argument, dataset data argument, estimand estimand argument (, ATT). default, optweight() minimizes \\(L_2\\) norm, requires exact mean balance covariates (.e., \\(\\delta_k=0\\)), requires exact mean target balance covariates (.e., \\(\\varepsilon_k=0\\)), requires weights greater \\(w_\\text{min}=10^{-8}\\). Using cobalt::bal.tab() output computes weighted balance statistics; particular, produce weighted (standardized) mean differences covariates well effective sample size (ESS), represents approximate size unweighted sample produces precision weighted sample. expected, mean differences exactly 0 weighted sample. can use summary() examine properties weights: summary() produces information distribution weights, including different measures dispersion weights, corresponds one allowed objective functions minimize. L2 square root mean squared deviation estimated weights base weights (.e., \\(L_2\\) divergence); , base weights 1. See help page summary.optweight() information statistics. Lastly, summary() produces weighted original (effective) samples sizes. can use plot() summary() output visualize distribution weights:  targeted ATT, weights control group displayed (treated group weights 1). , ’ll adjust arguments see affects weights.","code":"library(optweight)  data(\"lalonde\", package = \"cobalt\")  head(lalonde) ##   treat age educ   race married nodegree re74 re75    re78 ## 1     1  37   11  black       1        1    0    0  9930.0 ## 2     1  22    9 hispan       0        1    0    0  3595.9 ## 3     1  30   12  black       0        0    0    0 24909.5 ## 4     1  27   11  black       0        1    0    0  7506.1 ## 5     1  33    8  black       0        1    0    0   289.8 ## 6     1  22    9  black       0        1    0    0  4056.5 ow <- optweight(treat ~ age + educ + race + married +                   nodegree + re74 + re75,                 data = lalonde,                 estimand = \"ATT\") ow ## An optweight object ##  - number of obs.: 614 ##  - norm minimized: \"l2\" ##  - sampling weights: present ##  - base weights: present ##  - treatment: 2-category ##  - estimand: ATT (focal: 1) ##  - covariates: age, educ, race, married, nodegree, re74, re75 cobalt::bal.tab(ow) ## Balance Measures ##                Type Diff.Adj ## age         Contin.       -0 ## educ        Contin.       -0 ## race_black   Binary       -0 ## race_hispan  Binary        0 ## race_white   Binary        0 ## married      Binary       -0 ## nodegree     Binary       -0 ## re74        Contin.       -0 ## re75        Contin.       -0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.      185 ## Adjusted     108.6     185 summary(ow) ##                   Summary of weights ## - Weight ranges: ##  ##         Min                                 Max ## treated   1      ||                       1.    ## control   0 |---------------------------| 6.002 ##  ## - Units with the 5 most extreme weights by group: ##                                       ##              1     2    3     4     5 ##  treated     1     1    1     1     1 ##            423   388  226   196   118 ##  control 5.568 5.602 5.67 5.922 6.002 ##  ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.       0.         0 ## control 1.717 1.339 5.002    1.23       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     108.6     185 summary(ow) |> plot()"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"balance-tolerance-tols","dir":"Articles","previous_headings":"Using optweight","what":"Balance tolerance: tols","title":"Using optweight to Estimate Stable Balancing Weights","text":"group balance tolerance controlled tols argument. can either single value applied covariates vector value covariate. default, tols = 0. Let’s see happens increase tols .02. Now, mean differences less .021. Allowing relaxed imbalance also increases ESS. \\(L_2\\) statistic shrunk correspondingly: supply covariate balance tolerance, named vector must supplied. can sometimes little tedious, helper function, process_tols(), simplifies . Give process_tols() formula dataset (, optionally, initial tolerance value vector thereof), return modifiable vector balance tolerances can supplied optweight(). , ’ll relax constraint race setting group balance tolerance .07 re-estimate weights. can see covariates race, mean differences .02, race, mean differences .07. led increase ESS due relaxed constraints.","code":"ow2 <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATT\",                  tols = .02)  cobalt::bal.tab(ow2) ## Balance Measures ##                Type Diff.Adj ## age         Contin.     0.02 ## educ        Contin.     0.02 ## race_black   Binary     0.02 ## race_hispan  Binary     0.00 ## race_white   Binary    -0.02 ## married      Binary    -0.02 ## nodegree     Binary     0.02 ## re74        Contin.    -0.02 ## re75        Contin.     0.02 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.      185 ## Adjusted     118.8     185 summary(ow2, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.      0.          0 ## control 1.616 1.267 4.212   1.118       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     118.8     185 tols <- process_tols(treat ~ age + educ + race + married +                        nodegree + re74 + re75,                      data = lalonde,                      tols = .02) tols ##  - tols: ##      age     educ     race  married nodegree     re74     re75  ##     0.02     0.02     0.02     0.02     0.02     0.02     0.02 tols[\"race\"] <- .07  tols ##  - tols: ##      age     educ     race  married nodegree     re74     re75  ##     0.02     0.02     0.07     0.02     0.02     0.02     0.02 ow3 <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATT\",                  tols = tols)  cobalt::bal.tab(ow3) ## Balance Measures ##                Type Diff.Adj ## age         Contin.     0.02 ## educ        Contin.     0.02 ## race_black   Binary     0.07 ## race_hispan  Binary     0.00 ## race_white   Binary    -0.07 ## married      Binary    -0.02 ## nodegree     Binary     0.02 ## re74        Contin.    -0.02 ## re75        Contin.     0.02 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.      185 ## Adjusted     132.7     185"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"norm","dir":"Articles","previous_headings":"Using optweight","what":"Objective function: norm","title":"Using optweight to Estimate Stable Balancing Weights","text":"norm argument controls objective function used. See table allowable values norm, names, formulas: \\(L_2\\) norm default. objective functions, thorough theoretical work done \\(L_2\\) norm relative entropy, tend easiest optimize. Weighting minimizing relative entropy also known “entropy balancing” (Hainmueller 2012; Källberg Waernbaum 2023; Zhao Percival 2017) also available WeightIt, uses parsimonious representation problem. Weighting minimizing sum negative logs equivalent nonparametric covariate balancing propensity score (npCBPS) weighting (Fong, Hazlett, Imai 2018), maximizes empirical likelihood data estimate weights. penalized version npCBPS available CBPS WeightIt (calls functions CBPS), optweight offers additional options possible packages, specifying balance tolerances, targets, different estimands. Different solvers available norm; see optweight() help page details. , ’ll minimize \\(L_2\\) norm, \\(L_1\\) norm, \\(L_\\infty\\) norm, relative entropy see choices affect properties weights. table statistics (rows) control group norm minimized (columns). can see minimizing \\(L_2\\) norm yields weights lowest \\(L_2\\) divergence, minimizing \\(L_1\\) norm yields weights lowest \\(L_1\\) divergence, minimizing \\(L_\\infty\\) norm yields weights lowest \\(L_\\infty\\) divergence, minimizing relative entropy yields weights lowest relative entropy. \\(L_2\\) divergence closest correspondence ESS (1:1 relationship), theoretical reasons prefer norms, especially correspond certain assumptions true propensity score model. See Källberg Waernbaum (2023) information assumptions.","code":"# L2 norm ow_l2 <- optweight(treat ~ age + educ + race + married +                      nodegree + re74 + re75,                    data = lalonde,                    estimand = \"ATT\",                    norm = \"l2\")  # L1 norm ow_l1 <- optweight(treat ~ age + educ + race + married +                      nodegree + re74 + re75,                    data = lalonde,                    estimand = \"ATT\",                    norm = \"l1\")  # L-infinity norm ow_linf <- optweight(treat ~ age + educ + race + married +                        nodegree + re74 + re75,                      data = lalonde,                      estimand = \"ATT\",                      norm = \"linf\",                      eps = 1e-5) # to improve convergence # Relative entropy ow_re <- optweight(treat ~ age + educ + race + married +                      nodegree + re74 + re75,                    data = lalonde,                    estimand = \"ATT\",                    norm = \"entropy\") ##            l2    l1  linf    RE ## L2      1.717 2.017 1.877 1.832 ## L1      1.339 1.281 1.548 1.287 ## L∞      5.002 9.924 3.577 8.420 ## Rel Ent 1.230 1.227 1.500 1.101"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"representativeness-estimand-targets-and-target-tols","dir":"Articles","previous_headings":"Using optweight","what":"Representativeness: estimand, targets, and target.tols","title":"Using optweight to Estimate Stable Balancing Weights","text":"Representativeness important occasionally neglected aspect weighting. degree given weighted sample can representative specific target population can controlled estimand, target, target.tols arguments, detail .","code":""},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"estimand","dir":"Articles","previous_headings":"Using optweight > Representativeness: estimand, targets, and target.tols","what":"estimand","title":"Using optweight to Estimate Stable Balancing Weights","text":"Different estimands can targeted supplying argument estimand. Allowable estimands include ATE, ATT, ATC. ensure covariate means group resemble full sample, treated group, control group, respectively. example, setting estimand = \"ATE\" requests groups weighted covariate means equal covariate means full sample, demonstrated . covariate means full sample can computed using cobalt::col_w_mean(): estimating weights target ATE, see weighted covariate means group equal full sample:","code":"covs <- lalonde[-c(1, 9)]  cobalt::col_w_mean(covs) ##         age        educ  race_black race_hispan  race_white     married  ##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153  ##    nodegree        re74        re75  ##      0.6303   4557.5466   2184.9382 ow_ate <- optweight(treat ~ age + educ + race + married +                       nodegree + re74 + re75,                     data = lalonde,                     estimand = \"ATE\")  cobalt::bal.tab(ow_ate, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   27.363   27.363        0 ## educ        Contin.   10.269   10.269        0 ## race_black   Binary    0.396    0.396        0 ## race_hispan  Binary    0.117    0.117        0 ## race_white   Binary    0.487    0.487       -0 ## married      Binary    0.415    0.415        0 ## nodegree     Binary    0.630    0.630        0 ## re74        Contin. 4557.547 4557.547        0 ## re75        Contin. 2184.938 2184.938        0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.   185.   ## Adjusted     343.5   50.72"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"targets","dir":"Articles","previous_headings":"Using optweight > Representativeness: estimand, targets, and target.tols","what":"targets","title":"Using optweight to Estimate Stable Balancing Weights","text":"addition targeting natural sample, ’s also possible target specific population characterized covariate means \\(\\bar{x}_k^*\\) supplying argument targets2. theory behind methodology described Chattopadhyay, Cohn, Zubizarreta (2024). request different target population, process_targets() can used create vector target means, supplied targets argument optweight(). default, process_targets() computes mean covariate full sample. can modified similarly tols specify target means. Note categorical covariates, proportions groups must sum 1. can supply optweight() request covariate means weighted sample equal target means. need set estimand = NULL ensure targets obeyed. Failing produce warning. treatment effect estimate method weighting interpretation estimate population similar means sample mean age 35 years (older original sample) racial profile 50% Black, 30% Hispanic, 20% white. may representativeness specific target population desired subset variables, e.g., expected effect modifiers. can remove constraints target balance entirely certain variable setting target values NA. can especially helpful cases low overlap, described Barnard, Huling, Wolfson (2025). , setting targets race categories NA: resulting weights still ensure -group balance (supplied tols), resulting weighted means untargeted variables happened optimize norm weights. can even relax target constraints solely prioritize -group balance setting targets = NA. yields kind “overlap” weights target whichever population optimizes objective function weights subject -group balance alone (Kallus Santacatterina 2019).","code":"targets1 <- process_targets(~ age + educ + race + married +                               nodegree + re74 + re75,                             data = lalonde)  targets1 ##  - targets: ##         age        educ  race_black race_hispan  race_white     married  ##     27.3632     10.2687      0.3958      0.1173      0.4870      0.4153  ##    nodegree        re74        re75  ##      0.6303   4557.5466   2184.9382 targets1[\"age\"] <- 35 targets1[c(\"race_black\", \"race_hispan\", \"race_white\")] <- c(.5, .3, .2)  targets1 ##  - targets: ##         age        educ  race_black race_hispan  race_white     married  ##     35.0000     10.2687      0.5000      0.3000      0.2000      0.4153  ##    nodegree        re74        re75  ##      0.6303   4557.5466   2184.9382 ow_target1 <- optweight(treat ~ age + educ + race + married +                           nodegree + re74 + re75,                         data = lalonde,                         targets = targets1,                         estimand = NULL)  cobalt::bal.tab(ow_target1, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   35.000   35.000       -0 ## educ        Contin.   10.269   10.269       -0 ## race_black   Binary    0.500    0.500       -0 ## race_hispan  Binary    0.300    0.300        0 ## race_white   Binary    0.200    0.200        0 ## married      Binary    0.415    0.415       -0 ## nodegree     Binary    0.630    0.630       -0 ## re74        Contin. 4557.547 4557.547       -0 ## re75        Contin. 2184.938 2184.938       -0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.    185.  ## Adjusted     133.5    25.6 targets2 <- process_targets(~ age + educ + race + married +                               nodegree + re74 + re75,                             data = lalonde)  # Set race targets to NA is.na(targets2[startsWith(names(targets2), \"race_\")]) <- TRUE  ow_target2 <- optweight(treat ~ age + educ + race + married +                           nodegree + re74 + re75,                         data = lalonde,                         targets = targets2,                         estimand = NULL)  cobalt::bal.tab(ow_target2, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   27.363   27.363        0 ## educ        Contin.   10.269   10.269        0 ## race_black   Binary    0.451    0.451        0 ## race_hispan  Binary    0.164    0.164       -0 ## race_white   Binary    0.386    0.386       -0 ## married      Binary    0.415    0.415        0 ## nodegree     Binary    0.630    0.630        0 ## re74        Contin. 4557.547 4557.547        0 ## re75        Contin. 2184.938 2184.938        0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.   185.   ## Adjusted     299.5   63.03 ow_target3 <- optweight(treat ~ age + educ + race + married +                           nodegree + re74 + re75,                         data = lalonde,                         targets = NA,                         estimand = NULL)  cobalt::bal.tab(ow_target3, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   25.877   25.877       -0 ## educ        Contin.   10.318   10.318        0 ## race_black   Binary    0.454    0.454       -0 ## race_hispan  Binary    0.166    0.166        0 ## race_white   Binary    0.380    0.380        0 ## married      Binary    0.319    0.319       -0 ## nodegree     Binary    0.626    0.626       -0 ## re74        Contin. 3316.369 3316.369        0 ## re75        Contin. 1994.888 1994.888        0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.   185.   ## Adjusted     283.1   76.99"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"target-tols","dir":"Articles","previous_headings":"Using optweight > Representativeness: estimand, targets, and target.tols","what":"target.tols","title":"Using optweight to Estimate Stable Balancing Weights","text":"eschewing target balance altogether requiring exact target balance allowing inexact target balance using target.tols, specified like tols argument. target.tols controls \\(\\varepsilon_k\\), .e., far midpoint group means can vary specified target mean. tols, can applied subset covariates simultaneously. Previously, used optweight() target specific target population defined targets1; resulting weights stored ow_target1. can increase ESS relaxing target balance constraint race. , create new vector target balance tolerances using process_tols() modify value race. can supply vector target balance tolerances target.tols argument optweight() relax target balance constraint without eliminating entirely. can see ESS increased due relaxing constraint target balance, means race category still close (.e., within 0.07 ) specified target values. wanted remove covariate’s target balance constraint entirely, set target value NA, previously, can set target balance tolerance Inf, age: general, makes sense maintain strict target balance constraints covariates, relaxing covariate suspected effect modifier (.e., representativeness covariate important) substantial precision gains can made . section Dual Variables describes determine whether latter scenario may effect.","code":"target.tols1 <- process_tols(treat ~ age + educ + race + married +                                nodegree + re74 + re75,                              data = lalonde)  target.tols1[\"race\"] <- .07  target.tols1 ##  - tols: ##      age     educ     race  married nodegree     re74     re75  ##     0.00     0.00     0.07     0.00     0.00     0.00     0.00 ow_target1b <- optweight(treat ~ age + educ + race + married +                            nodegree + re74 + re75,                          data = lalonde,                          targets = targets1,                          target.tols = target.tols1,                          estimand = NULL)  cobalt::bal.tab(ow_target1b, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   35.000   35.000       -0 ## educ        Contin.   10.269   10.269       -0 ## race_black   Binary    0.522    0.522       -0 ## race_hispan  Binary    0.230    0.230        0 ## race_white   Binary    0.248    0.248        0 ## married      Binary    0.415    0.415       -0 ## nodegree     Binary    0.630    0.630       -0 ## re74        Contin. 4557.547 4557.547       -0 ## re75        Contin. 2184.938 2184.938       -0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.   185.   ## Adjusted     148.4   31.26 target.tols1[\"age\"] <- Inf  target.tols1 ##  - tols: ##      age     educ     race  married nodegree     re74     re75  ##      Inf     0.00     0.07     0.00     0.00     0.00     0.00 ow_target1c <- optweight(treat ~ age + educ + race + married +                            nodegree + re74 + re75,                          data = lalonde,                          targets = targets1,                          target.tols = target.tols1,                          estimand = NULL)  cobalt::bal.tab(ow_target1c, disp = \"m\") ## Balance Measures ##                Type  M.0.Adj  M.1.Adj Diff.Adj ## age         Contin.   26.495   26.495        0 ## educ        Contin.   10.269   10.269       -0 ## race_black   Binary    0.500    0.500        0 ## race_hispan  Binary    0.230    0.230       -0 ## race_white   Binary    0.270    0.270       -0 ## married      Binary    0.415    0.415        0 ## nodegree     Binary    0.630    0.630        0 ## re74        Contin. 4557.547 4557.547        0 ## re75        Contin. 2184.938 2184.938        0 ##  ## Effective sample sizes ##            Control Treated ## Unadjusted   429.   185.   ## Adjusted     246.7   71.72"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"sampling-weights-and-base-weights","dir":"Articles","previous_headings":"Using optweight","what":"Sampling weights and base weights","title":"Using optweight to Estimate Stable Balancing Weights","text":"Sampling weights base weights different forms initially computed weights can used modify optimization problem. used two different purposes, describe .","code":""},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"sampling-weights-s-weights","dir":"Articles","previous_headings":"Using optweight > Sampling weights and base weights","what":"Sampling weights: s.weights","title":"Using optweight to Estimate Stable Balancing Weights","text":"Sampling weights used attempting generalize estimates sample specific target population characterized sampling weights. datasets come sampling weights order analyses using valid. weights can supplied s.weights argument optweight(). three effects: balance target constraints correspond product estimated sampling weights target values covariates weighted sampling weights (supplied targets) contribution estimated weights objective function weighted sampling weights Sampling weights also used bootstrapping using fractional weighted bootstrap (Xu et al. 2020), e.g., implemented fwb package; see section Estimating Effects . default, s.weights specified, sampling weights equal 1.","code":""},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"base-weights-b-weights","dir":"Articles","previous_headings":"Using optweight > Sampling weights and base weights","what":"Base weights: b.weights","title":"Using optweight to Estimate Stable Balancing Weights","text":"Base weights set initial weights properties user wants retain enforcing balance constraints. estimated weights chosen minimize distance base weights, distance corresponds \\(f\\). weights can supplied b.weights argument optweight(). default, specified, base weights equal 1. example use base weights enforce balance set IPW weights estimated using flexible model unable exactly balance covariates. strategy used one winning methods 2016 ACIC data competition (Dorie et al. 2019). ’ll demonstrate use base weights . First, ’ll estimate propensity score weights using generalized boosted modeling WeightIt. flexible machine learning model, can request features beyond covariate means balanced minimizing largest Kolmogorov-Smirnov (KS) statistic weighted sample. Next ’ll use optweight() estimate set weights differ little possible estimated weights enforcing exact balance covariate means. ’ll also estimate SBW weights uniform base weights see difference properties weights. Finally, can look balance three sets weights means KS statistics. Looking mean differences (columns Diff.weightit, Diff.ow_bw, Diff.ow first table), can see GBM weights WeightIt alone balance covariate means, whereas set SBW weights optweight . However, second table, can see big differences KS statistics SBW weights incorporated base weights didn’t. KS statistics SBW weights incorporated base weights (listed KS.ow_bw column) close GBM weights (listed KS.weightit column) estimated weights close GBM weights. contrast, SBW weights didn’t incorporate base weights high KS statistics covariates (listed KS.ow column); unable take advantage distribution-balancing properties original GBM weights. way, incorporating base weights provides middle ground GBM weights basic SBW weights: ensure exact balance means attempting retain much similarity GBM weights possible, thereby inheriting balancing properties. Unfortunately, one properties also low ESS, though case, little ESS lost enforcing additional balance constraints. Using different norms base weights can also effective using uniform base weights, different norms prioritize similarity base weights ways may retain different properties3.","code":"# GBM IPW weights W_gbm <- WeightIt::weightit(treat ~ age + educ + race + married +                               nodegree + re74 + re75,                             data = lalonde,                             estimand = \"ATT\",                             method = \"gbm\",                             criterion = \"ks.max\") # SBW with GBM base weights ow_bw <- optweight(treat ~ age + educ + race + married +                      nodegree + re74 + re75,                    data = lalonde,                    estimand = \"ATT\",                    b.weights = W_gbm$weights) # SBW without base weights ow <- optweight(treat ~ age + educ + race + married +                   nodegree + re74 + re75,                 data = lalonde,                 estimand = \"ATT\") # Mean diferences cobalt::bal.tab(W_gbm, stats = \"m\",                 weights = list(ow_bw = ow_bw$weights,                                ow = ow$weights)) ## Balance Measures ##                 Type Diff.weightit Diff.ow_bw Diff.ow ## prop.score  Distance         0.577      0.571   1.782 ## age          Contin.         0.053      0.000  -0.000 ## educ         Contin.        -0.080     -0.000  -0.000 ## race_black    Binary         0.017      0.000  -0.000 ## race_hispan   Binary         0.002     -0.000   0.000 ## race_white    Binary        -0.018     -0.000   0.000 ## married       Binary         0.005      0.000  -0.000 ## nodegree      Binary         0.062      0.000  -0.000 ## re74         Contin.         0.111      0.000  -0.000 ## re75         Contin.         0.126      0.000  -0.000 ##  ## Effective sample sizes ##          Control Treated ## All       429.       185 ## weightit   24.71     185 ## ow_bw      24.54     185 ## ow        108.64     185 # KS statistics cobalt::bal.tab(W_gbm, stats = \"ks\",                 weights = list(ow_bw = ow_bw$weights,                                ow = ow$weights)) ## Balance Measures ##                 Type KS.weightit KS.ow_bw KS.ow ## prop.score  Distance       0.223    0.222 0.615 ## age          Contin.       0.096    0.102 0.283 ## educ         Contin.       0.069    0.057 0.042 ## race_black    Binary       0.017    0.000 0.000 ## race_hispan   Binary       0.002    0.000 0.000 ## race_white    Binary       0.018    0.000 0.000 ## married       Binary       0.005    0.000 0.000 ## nodegree      Binary       0.062    0.000 0.000 ## re74         Contin.       0.062    0.037 0.226 ## re75         Contin.       0.096    0.056 0.140 ##  ## Effective sample sizes ##          Control Treated ## All       429.       185 ## weightit   24.71     185 ## ow_bw      24.54     185 ## ow        108.64     185"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"dual-variables","dir":"Articles","previous_headings":"Using optweight","what":"Dual variables","title":"Using optweight to Estimate Stable Balancing Weights","text":"Dual variables, also known “shadow prices”, part output optimization problem represent “active” given constraint optimum (Zubizarreta 2015). large dual variable means relaxing constraint allow objective function reach lower value. related coefficients covariates propensity score model, representing much covariate contributing estimation weights. Zubizarreta (2015) describes utility dual variables SBW: can used determine covariates constraints can relaxed improve precision covariates constraints can tightened without affecting precision. dual variables available optweight() output duals component, can also plotted using plot(). can also useful diagnosing convergence failure; often, constraint impossible meet high dual variable solution can found. , ’ll demonstrate can use dual variables see modify constraints try take advantage bias-variance trade-. First ’ll estimate SBW weights balance tolerances .02 covariates. can print dual variables duals component output object plot plot():  , ’s clear race largest dual variable, re75 smallest. means can likely get biggest gains ESS relaxing balance constraint race, whereas tightening balance constraint re75 little effect ESS. , relax balance constraint race .1. relaxing constraint race, ESS increased quite bit. see increase instead relaxed constraint covariate smaller dual variable, like re75. , restore balance constraints .02 set balance constraint re75 .1. virtually effect ESS (relative balance tolerances equal .02). However, also suggests can tighten constraint re75 without much loss ESS. , decrease tolerance re75 0: see despite tighter tolerance, ESS remains . reference, balance statistics ESSs four sets weights: can see relaxing balance constraint race increases ESS significantly, whereas either tightening relaxing constraint re75 little effect ESS. Group balance constraints constraints can relaxed; estimand ATT targeted, also target balance constraints, constraint minimum weights may active well (.e., indicating requiring weights positive limits precision resulting weights). , demonstrate might differ targeting ATE: Plotting dual variables reveals separate dual variables target balance constraints:  group target balance constraints can modified independently using tols target.tols, respectively. case, believed race strong confounder weak effect modifier, may willing relax target balance constraints group balance constraint. can also plot sum dual variables type constraint examine set active setting type = \"constraints\" plot():  can see group balance target constraints similar limiting effects optimization, whereas weight range (controlled min_w) little effect example.","code":"tols <- process_tols(treat ~ age + educ + race + married +                        nodegree + re74 + re75,                      data = lalonde,                      tols = .02)  ow <- optweight(treat ~ age + educ + race + married +                   nodegree + re74 + re75,                 data = lalonde,                 estimand = \"ATT\",                 tols = tols)  summary(ow, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.      0.          0 ## control 1.616 1.267 4.212   1.118       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     118.8     185 ow$duals ##   component   constraint      cov    dual ## 1         0 weight range     <NA> 2.46151 ## 2         1      balance      age 0.24485 ## 3         1      balance     educ 0.62674 ## 4         1      balance     race 5.66548 ## 5         1      balance  married 1.05266 ## 6         1      balance nodegree 1.61135 ## 7         1      balance     re74 0.71501 ## 8         1      balance     re75 0.04373 plot(ow) tols[\"race\"] <- .1  ow2 <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATT\",                  tols = tols)  summary(ow2, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.       0.         0 ## control 1.424 1.113 3.638    0.91       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     141.7     185 tols[] <- .02 tols[\"re75\"] <- .1  ow3 <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATT\",                  tols = tols)  summary(ow3, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.      0.          0 ## control 1.616 1.267 4.207   1.118       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     118.8     185 tols[\"re75\"] <- 0  ow4 <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATT\",                  tols = tols)  summary(ow4, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##            L2    L1    L∞ Rel Ent # Zeros ## treated 0.    0.    0.       0.         0 ## control 1.617 1.269 4.229    1.12       0 ##  ## - Effective Sample Sizes: ##  ##            Control Treated ## Unweighted   429.      185 ## Weighted     118.7     185 cobalt::bal.tab(treat ~ age + educ + race + married +                   nodegree + re74 + re75,                 data = lalonde,                 weights = list(ow  = ow$weights,                                ow2 = ow2$weights,                                ow3 = ow3$weights,                                ow4 = ow4$weights)) ## Balance Measures ##                Type Diff.ow Diff.ow2 Diff.ow3 Diff.ow4 ## age         Contin.    0.02     0.02    0.020     0.02 ## educ        Contin.    0.02     0.02    0.020     0.02 ## race_black   Binary    0.02     0.10    0.020     0.02 ## race_hispan  Binary    0.00     0.00    0.000     0.00 ## race_white   Binary   -0.02    -0.10   -0.020    -0.02 ## married      Binary   -0.02    -0.02   -0.020    -0.02 ## nodegree     Binary    0.02     0.02    0.020     0.02 ## re74        Contin.   -0.02    -0.02   -0.020    -0.02 ## re75        Contin.    0.02     0.02    0.026    -0.00 ##  ## Effective sample sizes ##     Control Treated ## All   429.      185 ## ow    118.8     185 ## ow2   141.7     185 ## ow3   118.8     185 ## ow4   118.7     185 ow <- optweight(treat ~ age + educ + race + married +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATE\") plot(ow) plot(ow, type = \"constraints\")"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"multivariate-treatments","dir":"Articles","previous_headings":"Using optweight","what":"Multivariate treatments","title":"Using optweight to Estimate Stable Balancing Weights","text":"possible supply balance constraints multiple (.e., multivariate) treatments simultaneously estimate single set weights satisfies . approach described Chen Zhou (2023) context multiple continuous treatments. optweightMV() provides interface balancing multiple treatments works similarly optweight(), though ability supply multiple balancing formulas. Though can used conceptually distinct treatments, can also sometimes useful use multiple transformations single treatment; example, Greifer (2020) found order eliminate bias due certain kinds imbalance continuous treatment, square centered treatment must uncorrelated covariates, addition treatment uncorrelated covariates. use optweightMV(), supply list balancing formulas formula.list argument. tols.list argument must also list vector tolerances treatment, value covariate. However, targets vector value unique covariate since one specify multiple targets covariate. example (run) specify call optweightMV(): syntax can abbreviated supplying single value element tols.list applied covariates, e.g., tols.list = list(.01, .02, .03); , vector balance tolerance desired covariates treatments, list single vector, e.g., tols.list = list(c(x1 = .01, x2 = .01, x3 = .01)); , tolerance desired covariates treatments, list single value, e.g., tols.list = list(.02). targets can omitted target ATE (.e., balance covariates means sample), estimands can specified. One might tempted use optweightMV() estimate balancing weights longitudinal treatments. possible, ’s simple supplying balancing formula treatment balancing treatment covariate history treatment (Yiu Su 2020). Zhou Wodtke (2020) describe specify balance constraints entropy balancing longitudinal treatments, involve balancing covariate directly rather residuals regressions covariates treatment covariate histories. Functionality specific method present optweight, available rbw package. may possible implement optweight manually, advise .","code":"owmv <- optweightMV(list(t1 ~ x1 + x2 + x3,                          t2 ~ x1 + x2 + x3,                          t3 ~ x1 + x2 + x3),                     data = data,                     tols.list = list(c(x1 = .01, x2 = .01, x3 = .01),                                      c(x1 = .02, x2 = .02, x3 = .02),                                      c(x1 = .03, x2 = .03, x3 = .03)),                     targets = c(x1 = 10, x2 = .34, x3 = 5.5))"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"optweight-svy","dir":"Articles","previous_headings":"Using optweight","what":"optweight.svy()","title":"Using optweight to Estimate Stable Balancing Weights","text":"goal balance treatment groups target population rather balance one sample target distribution, one can use optweight.svy() instead optweight(). .svy suffix indication can used method generate survey weights sample generalizes population interest specific means. optweight.svy() works just like optweight() except treatment variable specified targets specified. useful context matching-adjusted indirect comparison (MAIC, Signorovitch et al. 2010), involves weighting given trial sample resemble covariate distribution trial’s sample. MAIC originally described equivalent entropy balancing (Phillippo et al. 2020), can requested setting norm = \"entropy\". , demonstrate weighting control subset lalonde resemble specific target population. optweightit(), can helpful use process_targets() simplify specification covariates means. variables dataset specified, formula can omitted (process_targets() optweight.svy()). request individual means, targets can set values. allow covariate mean vary freely, one can either omit calls process_targets() optweight.svy() set target value NA. ’ll re78, set specific targets variables except re75, ’ll leave mean. can supply optweight.svy(). time ’ll set min.w 0 allow weights 0 effectively dropped sample. can see weights required move sample toward specified target decrease ESS quite bit, several units given weights 0. can actually good thing means less data needs collected since weights 0 necessary subsequent analysis. can examine weighted covariate means using cobalt::col_w_means() , estimated weights supplied s.weights: can see weighted mean re78 whatever minimized \\(L_2\\) norm weights since constraint placed . optweight(), can see much constraint contributed increase variability examining dual variables:  ’s clear constraint re74 contributing , relaxing constraint greatest impact ESS. constraint can relaxed either changing target one closer original data (closer constraint placed re74) setting relaxed tolerance re74 using tols. ’ll use latter option : set tolerance re74 300. need set std.cont = FALSE tell optweight.svy() tolerance continuous variables raw units, standardized units. Now can interpret constraint allowing weighted mean re74 within 300 specified target 1000. increased ESS weights, can see weighted mean re74 300 away 1000, variables specified targets.","code":"lalonde_c <- subset(lalonde, treat == 0,                     select = -c(treat))  targets <- process_targets(lalonde_c)  targets ##  - targets: ##         age        educ  race_black race_hispan  race_white     married  ##     28.0303     10.2354      0.2028      0.1422      0.6550      0.5128  ##    nodegree        re74        re75        re78  ##      0.5967   5619.2365   2466.4844   6984.1697 targets[\"age\"] <- 40 targets[\"educ\"] <- 9 targets[c(\"race_black\", \"race_hispan\", \"race_white\")] <- c(.2, .2, .6) targets[\"married\"] <- .6 targets[\"nodegree\"] <- .6 targets[\"re74\"] <- 1000 is.na(targets[\"re78\"]) <- TRUE  targets ##  - targets: ##         age        educ  race_black race_hispan  race_white     married  ##        40.0         9.0         0.2         0.2         0.6         0.6  ##    nodegree        re74        re75        re78  ##         0.6      1000.0      2466.5          NA ow_s <- optweight.svy(lalonde_c,                       targets = targets,                       min.w = 0)  ow_s ## An optweight.svy object ##  - number of obs.: 429 ##  - norm minimized: \"l2\" ##  - sampling weights: present ##  - base weights: present ##  - covariates: age, educ, race, married, nodegree, re74, re75, re78 summary(ow_s) ##                   Summary of weights ## - Weight ranges: ##  ##     Min                                 Max ## all   0 |---------------------------| 13.54 ##  ## - Units with the 5 most extreme weights: ##                                       ##        404   152    111     19     16 ##  all 9.488 9.669 11.326 11.429 13.537 ##  ##  ## - Weight statistics: ##  ##        L2  L1    L∞ # Zeros ## all 2.237 1.5 12.54     307 ##  ## - Effective Sample Sizes: ##  ##             Total ## Unweighted 429.   ## Weighted    71.44 cobalt::col_w_mean(lalonde_c, s.weights = ow_s$weights) ##         age        educ  race_black race_hispan  race_white     married  ##        40.0         9.0         0.2         0.2         0.6         0.6  ##    nodegree        re74        re75        re78  ##         0.6      1000.0      2466.5      4725.6 plot(ow_s) tols <- process_tols(lalonde_c, tols = 0)  tols[\"re74\"] <- 300  tols ##  - tols: ##      age     educ     race  married nodegree     re74     re75     re78  ##        0        0        0        0        0      300        0        0 ow_s2 <- optweight.svy(lalonde_c,                        targets = targets,                        min.w = 0,                        tols = tols,                        std.cont = FALSE)  summary(ow_s2, weight.range = FALSE) ##                   Summary of weights ##  ## - Weight statistics: ##  ##       L2   L1    L∞ # Zeros ## all 2.07 1.44 10.68     290 ##  ## - Effective Sample Sizes: ##  ##             Total ## Unweighted 429.   ## Weighted    81.15 cobalt::col_w_mean(lalonde_c, s.weights = ow_s2$weights) ##         age        educ  race_black race_hispan  race_white     married  ##        40.0         9.0         0.2         0.2         0.6         0.6  ##    nodegree        re74        re75        re78  ##         0.6      1300.0      2466.5      4710.8"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"est-effects","dir":"Articles","previous_headings":"","what":"Estimating effects","title":"Using optweight to Estimate Stable Balancing Weights","text":"SBW weights function just like IPW weights, procedures can used estimate effect treatment SBW-weighted sample. One needs run regression outcome treatment weights incorporated. critical usual standard errors lm() glm(), etc., used; special standard errors required weighting. See vignette(\"estimating-effects\", package = \"WeightIt\") details estimating effects weighting. WeightIt provides tools facilitating weights estimated using WeightIt::weightit(), provides interface optweight(), though slightly fewer options available. Often, best way account uncertainty estimating treatment effect SBW bootstrapping. ensures variability due estimating weights correctly incorporated. fractional weighted bootstrap (Xu et al. 2020) often particularly effective units dropped sample bootstrap replication. bootstrapping used (e.g., computationally demanding specified constraints expected satisfied bootstrap samples), using robust standard error can acceptable alternative. , demonstrate approaches lalonde data. First, estimate weights ATT fit outcome model. , must use usual standard errors produced running summary() lm() output; must use either bootstrapping robust standard error. First, ’ll use bootstrapping fwb, implements fractional weighted bootstrap. involves drawing set weights distribution performing entire analysis weights incorporated. weights supplied s.weights argument optweight() multiplied returned weights used lm()4. can use update() re-estimate SBW weights weighted regression model bootstrap replication. use robust standard error, ’s easiest use functions marginaleffects package. Supply output lm() marginaleffects::avg_comparisons() vcov = \"HC3\" request robust standard error treatment effect estimate. Robust standard errors treat weights fixed, often yields larger standard errors bootstrap.","code":"ow <- optweight(treat ~ age + educ + race + married +                   nodegree + re74 + re75,                 data = lalonde,                 estimand = \"ATT\",                 eps = 1e-5)  fit <- lm(re78 ~ treat, data = lalonde,           weights = ow$weights)  coef(fit) ## (Intercept)       treat  ##        5145        1204 library(fwb)  bootfun <- function(data, w) {   ow_boot <- update(ow, s.weights = w)   fit_boot <- update(fit, weights = ow_boot$weights * w)      coef(fit_boot) }  set.seed(123)  boot <- fwb(lalonde, bootfun,             R = 500, # more is always better, but slower             verbose = FALSE)  summary(boot, ci.type = \"wald\", p.value = TRUE) ##             Estimate Std. Error CI 2.5 % CI 97.5 % z value Pr(>|z|)     ## (Intercept)     5145        571     4026      6263    9.02   <2e-16 *** ## treat           1204        754     -274      2682    1.60     0.11     ## --- ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 library(marginaleffects)  avg_comparisons(fit,                 variables = \"treat\",                 vcov = \"HC3\",                 newdata = subset(treat == 1)) ##  ##  Estimate Std. Error    z Pr(>|z|)   S 2.5 % 97.5 % ##      1204        824 1.46    0.144 2.8  -411   2819 ##  ## Term: treat ## Type: response ## Comparison: 1 - 0"},{"path":"https://ngreifer.github.io/optweight/articles/optweight.html","id":"further-reading","dir":"Articles","previous_headings":"","what":"Further reading","title":"Using optweight to Estimate Stable Balancing Weights","text":"methods implemented described several papers. selected annotated reading list information weights uses, properties, extensions. canonical reference SBW Zubizarreta (2015), introduces . general theory weighting balance described applied audiences Chattopadhyay, Hase, Zubizarreta (2020) Cohn Zubizarreta (2025). complete theoretical perspective SBW offered Y. Wang Zubizarreta (2020). Note results primarily extend cases constraint nonnegativity weights removed. Chan, Yam, Zhang (2016) describe general framework includes SBW, focus exact balance. specific method describe equivalent entropy balancing (.e., using norm = \"entropy\"). Entropy balancing general described Hainmueller (2012) expanded Zhao Percival (2017) Källberg Waernbaum (2023). SBW multi-category treatments described de los Angeles Resa Zubizarreta (2020). SBW continuous treatments described Greifer (2020). Related theory continuous treatments context entropy balancing described Tübbicke (2022) Vegetabile et al. (2021). SBW generalizing single sample target population (.e., implemented optweight.svy()), also known matching-adjusted indirect comparison (MAIC), described Jackson, Rhodes, Ouwens (2021). general theory MAIC developed Signorovitch et al. (2010) reviewed Jiang et al. (2024). J. Wang (2021) also discusses MAIC, including performance different norm choices. SBW simultaneously balancing generalizing target population described Chattopadhyay, Cohn, Zubizarreta (2024). connections SBW g-computation estimating treatments effects described Chattopadhyay Zubizarreta (2023), Chattopadhyay, Greifer, Zubizarreta (2024), Chattopadhyay Zubizarreta (2024).","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Noah Greifer. Author, maintainer.","code":""},{"path":"https://ngreifer.github.io/optweight/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Greifer N (2026). optweight: Optimization-Based Stable Balancing Weights. R package version 1.0.0.9004, https://ngreifer.github.io/optweight/.","code":"@Manual{,   title = {optweight: Optimization-Based Stable Balancing Weights},   author = {Noah Greifer},   year = {2026},   note = {R package version 1.0.0.9004},   url = {https://ngreifer.github.io/optweight/}, }"},{"path":"https://ngreifer.github.io/optweight/index.html","id":"optweight-optimization-based-stable-balancing-weights-","dir":"","previous_headings":"","what":"Optimization-Based Stable Balancing Weights","title":"Optimization-Based Stable Balancing Weights","text":"optweight contains functions estimate stable balancing weights balance covariates given thresholds. solves convex optimization problem minimize function weights captures variability (divergence set base weights). method described Zubizarreta (2015), Källberg Waernbaum (2023), Wang Zubizarreta (2020). optweight extends method multi-category, continuous, multivariate treatments provides simple user interface compatibility cobalt package balance assessment. See vignette(\"optweight\") thorough description package’s capabilities. install optweight, use code : example estimating weights optweight assessing balance covariates cobalt. can see standardized mean differences .01 absolute value, requested using tols argument. set min.w = 0, units received weights 0, effectively dropping sample (default, smallest weight allowed \\(10^{-8}\\)). can use plot() examine dual variables constraint, represent active constraint optimal point. Highly active constraints affect objective function value tolerances changed.  can see race highest dual variable; relaxing constraint race yield biggest improvement effective sample size, tightening constraint yield biggest decrease effective sample size. lower-level function optweight.fit() operates covariates treatment variables directly. optweightMV() supports multivariate (.e., multiple) treatments. addition estimating balancing weights estimating treatment effects, optweight can estimate sampling weights generalizing estimate new target population defined covariate moments using optweight.svy(), implements methods described Jackson, Rhodes, Ouwens (2021) matching-adjusted indirect comparison (MAIC). cite optweight, please use citation(\"optweight\") generate correct reference. sure include version package. Please submit bug reports, questions, comments, issues https://github.com/ngreifer/optweight/issues.","code":"#CRAN version install.packages(\"optweight\")  #Development version pak::pkg_install(\"ngreifer/optweight\") library(\"optweight\") library(\"cobalt\")  data(\"lalonde\")  # Estimate weights ow <- optweight(treat ~ age + educ + race + nodegree + married +                   re74 + re75,                 data = lalonde,                 estimand = \"ATT\",                 tols = .01,                 min.w = 0) ow #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: ATT (focal: 1) #>  - covariates: age, educ, race, nodegree, married, re74, re75 # Information about the weights summary(ow) #>                   Summary of weights #> - Weight ranges: #>  #>         Min                                 Max #> treated   1      ||                       1.    #> control   0 |---------------------------| 5.588 #>  #> - Units with the 5 most extreme weights by group: #>                                       #>             1     2     3     4     5 #>  treated    1     1     1     1     1 #>           423   388   226   196   118 #>  control 5.27 5.298 5.324 5.479 5.588 #>  #>  #> - Weight statistics: #>  #>            L2    L1    L∞ # Zeros #> treated 0.    0.    0.          0 #> control 1.663 1.302 4.588     231 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted   429.      185 #> Weighted     113.9     185 # Covariate balance bal.tab(ow) #> Balance Measures #>                Type Diff.Adj #> age         Contin.     0.01 #> educ        Contin.     0.01 #> race_black   Binary     0.01 #> race_hispan  Binary    -0.00 #> race_white   Binary    -0.01 #> nodegree     Binary     0.01 #> married      Binary    -0.01 #> re74        Contin.    -0.01 #> re75        Contin.     0.01 #>  #> Effective sample sizes #>            Control Treated #> Unadjusted   429.      185 #> Adjusted     113.9     185 plot(ow)"},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/optweight-package.html","id":null,"dir":"Reference","previous_headings":"","what":"optweight: Optimization-Based Stable Balancing Weights — optweight-package","title":"optweight: Optimization-Based Stable Balancing Weights — optweight-package","text":"Use optimization estimate weights balance covariates binary, multi-category, continuous, multivariate treatments spirit Zubizarreta (2015) doi:10.1080/01621459.2015.1023805 . degree balance can specified covariate. addition, sampling weights can estimated allow sample generalize population specified given target moments covariates, matching-adjusted indirect comparison (MAIC).","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/optweight-package.html","id":"author","dir":"Reference","previous_headings":"","what":"Author","title":"optweight: Optimization-Based Stable Balancing Weights — optweight-package","text":"Maintainer: Noah Greifer noah.greifer@gmail.com (ORCID)","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":null,"dir":"Reference","previous_headings":"","what":"Stable Balancing Weights — optweight","title":"Stable Balancing Weights — optweight","text":"Estimates stable balancing weights supplied treatments covariates. degree balance covariate specified tols target population can specified targets estimand. See Zubizarreta (2015) Wang & Zubizarreta (2020) details properties weights methods used fit .","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Stable Balancing Weights — optweight","text":"","code":"optweight(   formula,   data = NULL,   tols = 0,   estimand = \"ATE\",   targets = NULL,   target.tols = 0,   s.weights = NULL,   b.weights = NULL,   focal = NULL,   norm = \"l2\",   min.w = 1e-08,   verbose = FALSE,   ... )  optweight.fit(   covs,   treat,   tols = 0,   estimand = \"ATE\",   targets = NULL,   target.tols = 0,   s.weights = NULL,   b.weights = NULL,   focal = NULL,   norm = \"l2\",   std.binary = FALSE,   std.cont = TRUE,   min.w = 1e-08,   verbose = FALSE,   solver = NULL,   ... )"},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Stable Balancing Weights — optweight","text":"formula formula treatment variable left hand side covariates balanced right hand side, list thereof. Interactions functions covariates allowed. data optional data set form data frame contains variables formula. tols vector balance tolerance values covariate. resulting weighted balance statistics least small values. one value supplied, applied covariates. Can also output call process_tols(). See Details. Default 0 covariates. estimand string containing desired estimand, determines target population. binary treatments, can \"ATE\", \"ATT\", \"ATC\", NULL. multi-category treatments, can \"ATE\", \"ATT\", NULL. continuous treatments, can \"ATE\" NULL. default \"ATE\". estimand ignored targets non-NULL. estimand targets NULL, targeting take place. See Details. targets optional vector target population mean values covariate. resulting weights ensure midpoint group means within target.tols units target values covariate. NULL NA, estimand used determine targets. Otherwise, estimand ignored. target values NA, corresponding variable targeted weighted mean wherever weights yield smallest value objective function; allowed binary multi-category treatments. Can also output call process_targets(). See Details. target.tols vector target balance tolerance values covariate. binary multi-category treatments, average pair means far target means values. Can also output call process_tols(). See Details. Default 0 covariates. Ignored continuous treatments estimand \"ATT\" \"ATC\". s.weights vector sampling weights. optweight(), can also name variable data contains sampling weights. b.weights vector base weights. supplied, desired norm distance estimated weights base weights minimized. optweight(), can also name variable data contains base weights. focal multi-category treatments used estimand = \"ATT\", group consider \"treated\" focal group. group weighted, groups weighted like focal group. specified, estimand automatically set \"ATT\". norm character; string containing name norm corresponding objective function minimize. Allowable options include \"l1\" \\(L_1\\) norm, \"l2\" \\(L_2\\) norm (default), \"linf\" \\(L_\\infty\\) norm, \"entropy\" relative entropy, \"log\" sum negative logs. See Details. min.w numeric; single value less 1 smallest allowable weight. analyses require nonzero weights units, small, nonzero minimum may desirable. default 1e-8 (\\(10^{-8}\\)), materially change properties weights minimum 0 prevents warnings packages use weights model fitting. norm \"entropy\" \"log\" min.w <= 0, min.w set smallest nonzero value. verbose logical; whether information optimization problem solution printed. Default FALSE. ... optweight(), additional arguments passed optweight.fit(), including options passed settings function corresponding solver. covs numeric matrix covariates balanced. treat vector treatment statuses. Non-numeric (.e., factor character) vectors allowed. std.binary, std.cont logical; whether tolerances standardized mean units (TRUE) raw units (FALSE) binary variables continuous variables, respectively. default FALSE std.binary raw proportion differences make sense standardized mean difference binary variables. arguments analogous binary continuous arguments cobalt::bal.tab(). solver string; name optimization solver use. Allowable options depend norm. Default use whichever eligible solver installed, , default solver corresponding norm. See Details information.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Stable Balancing Weights — optweight","text":"optweight(), optweight object following elements: weights estimated weights, one unit. treat values treatment variable. covs covariates used fitting. includes raw covariates, may altered fitting process. s.weights provided sampling weights. b.weights provided base weights. estimand estimand requested. focal focal variable ATT requested multi-category treatment. call function call. tols balance tolerance values covariate. target.tols target balance tolerance values covariate. duals data.frame containing dual variables covariate. See Details interpretation values. info list containing information performance optimization termination. norm norm used. solver solver used. optweight.fit(), optweight.fit object following elements: w estimated weights, one unit. duals data.frame containing dual variables covariate. info list containing information performance optimization termination. norm norm used. solver solver used.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Stable Balancing Weights — optweight","text":"optweight() primary user-facing function estimating stable balancing weights. optimization performed lower-level function optweight.fit(), transforms inputs required inputs optimization functions supplies outputs (weights, dual variables, convergence information) back optweight(). Little processing inputs performed optweight.fit(), normally handled optweight(). binary multi-category treatments, weights estimated weighted mean differences covariates within given tolerance thresholds controlled tols target.tols (unless std.binary std.cont TRUE, case standardized mean differences considered binary continuous variables, respectively). covariate \\(x\\) specified balance tolerance \\(\\delta\\) target tolerance \\(\\varepsilon\\), weighted means group within \\(\\delta\\) , midpoint weighted group means \\(\\varepsilon\\) target means. specifically, constraints specified follows: $$ \\left| \\bar{x}^w_1 - \\bar{x}^w_0 \\right| \\le \\delta \\\\ \\left| \\frac{\\bar{x}^w_1 + \\bar{x}^w_0}{2} - \\bar{x}^* \\right| \\le \\varepsilon $$ \\(\\bar{x}^w_1\\) \\(\\bar{x}^w_0\\) weighted means covariate \\(x\\) treatment groups 1 0, respectively, \\(\\bar{x}^*\\) target mean covariate. \\(\\delta\\) corresponds tols, \\(\\varepsilon\\) corresponds target.tols. Setting covariate's value target.tols Inf target NA serve remove second constraint, done Barnard et al. (2025). standardized tolerance values requested, standardization factor corresponds estimand requested: ATE requested target population specified, standardization factor square root average variance covariate across treatment groups, ATT ATC requested, standardization factor standard deviation covariate focal group. standardization factor computed accounting s.weights. Target balance constraints applied product estimated weights sampling weights. addition, sum product estimated weights sampling weights constrained equal sum product base weights sampling weights. binary multi-category treatments, constraints apply within treatment group.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"continuous-treatments","dir":"Reference","previous_headings":"","what":"Continuous treatments","title":"Stable Balancing Weights — optweight","text":"continuous treatments, weights estimated weighted correlation treatment covariate within specified tolerance threshold. means weighted covariates treatment restricted exactly equal target population ensure generalizability desired target population, regardless tols target.tols. weighted correlation computed weighted covariance divided product unweighted standard deviations. means used center variables computing covariance specified target population.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"norm","dir":"Reference","previous_headings":"","what":"norm","title":"Stable Balancing Weights — optweight","text":"objective function optimization problem \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right)\\), \\(\\mathbf{w}=\\{w_1, \\dots, w_n\\}\\) estimated weights, \\(\\mathbf{s}=\\{s_1, \\dots, s_n\\}\\) sampling weights (supplied s.weights), \\(\\mathbf{b}=\\{b_1, \\dots, b_n\\}\\) base weights (supplied b.weights). norm argument determines \\(f(.,.,.)\\), detailed : norm = \"l2\", \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right) = \\frac{1}{n} \\sum_i {s_i(w_i - b_i)^2}\\) norm = \"l1\", \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right) = \\frac{1}{n} \\sum_i {s_i \\vert w_i - b_i \\vert}\\) norm = \"linf\", \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right) = \\max_i {\\vert w_i - b_i \\vert}\\) norm = \"entropy\", \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right) = \\frac{1}{n} \\sum_i {s_i w_i \\log \\frac{w_i}{b_i}}\\) norm = \"log\", \\(f\\left(\\mathbf{w}, \\mathbf{b},\\mathbf{s}\\right) = \\frac{1}{n} \\sum_i {-s_i \\log \\frac{w_i}{b_i}}\\) default, s.weights b.weights set 1 units unless supplied. b.weights must positive norm \"entropy\" \"log\", norm = \"linf\" used s.weights supplied. norm = \"l2\" s.weights b.weights NULL, weights estimated maximize effective sample size. norm = \"entropy\", estimated weights equivalent entropy balancing weights (Källberg & Waernbaum, 2023). norm = \"log\", b.weights ignored optimization, affect estimated weights.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"dual-variables","dir":"Reference","previous_headings":"","what":"Dual Variables","title":"Stable Balancing Weights — optweight","text":"Two types constraints may associated covariate: target constraints balance constraints, controlled target.tols tols, respectively. duals component output, covariate dual variable constraint placed . dual variable constraint instantaneous rate change objective function optimum corresponding change constraint. relationship linear, large changes constraint exactly map onto corresponding changes objective function optimum, close small changes constraint. example, covariate balance constraint .01 corresponding dual variable 40, increasing (.e., relaxing) constraint .025 decrease value objective function optimum approximately \\((.025 - .01) * 40 = .6\\). factor variables, optweight() takes sum absolute dual variables constraints levels reports single dual variable variable . summed dual variable works way dual variables continuous variables . addition dual variable computed constraint range weights, controlled min.w. high dual variable constraint implies decreasing min.w decrease value objective function optimum.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"solver","dir":"Reference","previous_headings":"","what":"solver","title":"Stable Balancing Weights — optweight","text":"solver argument controls optimization solver used. Different solvers compatible norm. See table allowable options, package require, function solving, function controls settings. Note \"lpsolve\" can used min.w nonnegative. default solver norm follows: package corresponding default solver installed package different eligible solver , used. Otherwise, asked install required package. osqp required optweight, default \"l1\" \"linf\" norms highs installed. default package one shown good performance given norm informal testing; generally, eligible solvers perform equally well terms accuracy differ time taken.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"solving-convergence-failure","dir":"Reference","previous_headings":"","what":"Solving Convergence Failure","title":"Stable Balancing Weights — optweight","text":"Sometimes optimization fail converge solution. variety reasons might happen, include constraints nearly impossible satisfy optimization surface relatively flat. can hard know exact cause solve , section offers solutions one might try. Typically, solutions can found easily using \"l2\" norm; norms, especially \"linf\" \"l1\", likely see problems. Rarely problem iterations, though possible. problems can solved default 200,000 iterations, sometimes can help increase number max_iter argument. Usually, though, just ends taking time without solution found. problem constraints tight, can helpful loosen constraints. Sometimes examining dual variables solution failed converge can reveal constraints causing problem. extreme value dual variable typically suggests corresponding constraint one cause failure converge. Sometimes suboptimal solution possible; solution satisfy constraints exactly come pretty close. allow solutions, argument eps can increased larger values. likely occur s.weights supplied. Sometimes using different solver can improve performance. Using default solver norm, described , can reduce probability convergence failures.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Stable Balancing Weights — optweight","text":"Barnard, M., Huling, J. D., & Wolfson, J. (2025). Partially Retargeted Balancing Weights Causal Effect Estimation Positivity Violations (. arXiv:2510.22072). arXiv. doi:10.48550/arXiv.2510.22072 Chattopadhyay, ., Cohn, E. R., & Zubizarreta, J. R. (2024). One-Step Weighting Generalize Transport Treatment Effect Estimates Target Population. American Statistician, 78(3), 280–289. doi:10.1080/00031305.2023.2267598 de los Angeles Resa, M., & Zubizarreta, J. R. (2020). Direct Stable Weight Adjustment Non-Experimental Studies Multivalued Treatments: Analysis Effect Earthquake Post-Traumatic Stress. Journal Royal Statistical Society Series : Statistics Society, 183(4), 1387–1410. doi:10.1111/rssa.12561 Källberg, D., & Waernbaum, . (2023). Large Sample Properties Entropy Balancing Estimators Average Causal Effects. Econometrics Statistics. doi:10.1016/j.ecosta.2023.11.004 Wang, Y., & Zubizarreta, J. R. (2020). Minimal dispersion approximately balancing weights: Asymptotic properties practical considerations. Biometrika, 107(1), 93–105. doi:10.1093/biomet/asz050 Zubizarreta, J. R. (2015). Stable Weights Balance Covariates Estimation Incomplete Outcome Data. Journal American Statistical Association, 110(511), 910–922. doi:10.1080/01621459.2015.1023805","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/optweight.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Stable Balancing Weights — optweight","text":"","code":"library(\"cobalt\") #>  cobalt (Version 4.6.1, Build Date: 2025-08-20) data(\"lalonde\", package = \"cobalt\")  # Balancing covariates between treatment groups (binary) (ow1 <- optweight(treat ~ age + educ + married +                     nodegree + re74, data = lalonde,                   tols = c(.01, .02, .03, .04, .05),                   estimand = \"ATE\")) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: ATE #>  - covariates: age, educ, married, nodegree, re74 bal.tab(ow1) #> Balance Measures #>             Type Diff.Adj #> age      Contin.    -0.01 #> educ     Contin.     0.02 #> married   Binary    -0.03 #> nodegree  Binary     0.04 #> re74     Contin.    -0.05 #>  #> Effective sample sizes #>            Control Treated #> Unadjusted  429.     185.  #> Adjusted    415.09   125.3  # Exactly alancing covariates with respect to race (multi-category) (ow2 <- optweight(race ~ age + educ + married +                     nodegree + re74, data = lalonde,                   tols = 0, estimand = \"ATT\",                   focal = \"black\")) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 3-category (black, hispan, white) #>  - estimand: ATT (focal: black) #>  - covariates: age, educ, married, nodegree, re74 bal.tab(ow2) #> Balance summary across all treatment pairs #>             Type Max.Diff.Adj #> age      Contin.            0 #> educ     Contin.            0 #> married   Binary            0 #> nodegree  Binary            0 #> re74     Contin.            0 #>  #> Effective sample sizes #>            hispan  white black #> Unadjusted  72.   299.     243 #> Adjusted    45.96 181.39   243  # Balancing covariates between treatment groups (binary) # and requesting a specified target population targets <- process_targets(~ age + educ + married +                              nodegree + re74,                            data = lalonde,                            targets = c(26, 12, .4, .5,                                        1000))  (ow3a <- optweight(treat ~ age + educ + married +                      nodegree + re74, data = lalonde,                    targets = targets,                    estimand = NULL)) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: targets #>  - covariates: age, educ, married, nodegree, re74  bal.tab(ow3a, disp.means = TRUE) #> Note: `s.d.denom` not specified; assuming \"pooled\". #> Balance Measures #>             Type M.0.Adj M.1.Adj Diff.Adj #> age      Contin.    26.0    26.0       -0 #> educ     Contin.    12.0    12.0       -0 #> married   Binary     0.4     0.4       -0 #> nodegree  Binary     0.5     0.5       -0 #> re74     Contin.  1000.0  1000.0       -0 #>  #> Effective sample sizes #>            Control Treated #> Unadjusted  429.    185.   #> Adjusted    158.04   64.09  # Balancing covariates between treatment groups (binary) # and not requesting a target population (ow3b <- optweight(treat ~ age + educ + married +                      nodegree + re74, data = lalonde,                    targets = NULL,                    estimand = NULL)) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: targets #>  - covariates: age, educ, married, nodegree, re74  bal.tab(ow3b, disp.means = TRUE) #> Note: `s.d.denom` not specified; assuming \"pooled\". #> Balance Measures #>             Type   M.0.Adj   M.1.Adj Diff.Adj #> age      Contin.   26.4160   26.4160       -0 #> educ     Contin.   10.3547   10.3547       -0 #> married   Binary    0.3615    0.3615       -0 #> nodegree  Binary    0.6305    0.6305       -0 #> re74     Contin. 3908.9059 3908.9059       -0 #>  #> Effective sample sizes #>            Control Treated #> Unadjusted  429.    185.   #> Adjusted    382.74  139.23  # Using a different norm (ow1b <- optweight(treat ~ age + educ + married +                     nodegree + re74, data = lalonde,                   tols = c(.01, .02, .03, .04, .05),                   estimand = \"ATE\",                   norm = \"l1\")) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l1\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: ATE #>  - covariates: age, educ, married, nodegree, re74  summary(ow1b, weight.range = FALSE) #>                   Summary of weights #>  #> - Weight statistics: #>  #>            L2    L1     L∞ Rel Ent # Zeros #> treated 1.637 0.422 16.956   0.567       0 #> control 1.03  0.165 16.058   0.222       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.    185.   #> Weighted    208.09   50.29 summary(ow1, weight.range = FALSE) #>                   Summary of weights #>  #> - Weight statistics: #>  #>            L2    L1    L∞ Rel Ent # Zeros #> treated 0.69  0.536 3.419   0.198       0 #> control 0.183 0.166 0.424   0.017       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.     185.  #> Weighted    415.09   125.3  # Allowing for negative weights ow4 <- optweight(treat ~ age + educ + married + race +                    nodegree + re74 + re75,                  data = lalonde,                  estimand = \"ATE\",                  min.w = -Inf)  summary(ow4) #>                   Summary of weights #> - Weight ranges: #>  #>            Min                                 Max #> treated -0.987 |---------------------------| 7.254 #> control  0.407     |-----|                   2.17  #>  #> - Units with the 5 most extreme weights by group: #>                                        #>            137   124    68    23    10 #>  treated 5.193 5.206 6.116 6.205 7.254 #>            388   375   226   196   118 #>  control 2.109  2.11 2.111 2.133  2.17 #>  #>  #> - Weight statistics: #>  #>            L2    L1    L∞ # Zeros #> treated 1.608 1.216 6.254       0 #> control 0.499 0.39  1.17        0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.    185.   #> Weighted    343.49   51.57  # Using `optweight.fit()` treat <- lalonde$treat covs <- splitfactor(lalonde[2:8], drop.first = \"if2\")  ow.fit <- optweight.fit(covs,                         treat = treat,                         tols = .02,                         estimand = \"ATE\",                         norm = \"l2\")"},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":null,"dir":"Reference","previous_headings":"","what":"Stable Balancing Weights for Generalization — optweight.svy","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"Estimates stable balancing weights generalize sample characterized supplied covariates given target population. target means specified targets maximum distance weighted covariate mean. See Jackson et al. (2021) details properties weights methods used fit .","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"","code":"optweight.svy(   formula,   data = NULL,   tols = 0,   targets = NULL,   s.weights = NULL,   b.weights = NULL,   norm = \"l2\",   min.w = 1e-08,   verbose = FALSE,   ... )  optweight.svy.fit(   covs,   targets,   tols = 0,   s.weights = NULL,   b.weights = NULL,   norm = \"l2\",   std.binary = FALSE,   std.cont = TRUE,   min.w = 1e-08,   verbose = FALSE,   solver = NULL,   ... )"},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"formula formula nothing left hand side covariates targeted right hand side. Interactions functions covariates allowed. Can omitted, case variables data assumed targeted. data NULL formula data.frame, data replaced formula. data optional data set form data frame contains variables formula. tols vector target balance tolerance values covariate. resulting weighted covariate means away targets specified values. one value supplied, applied covariates. Can also output call process_tols(). Default 0 covariates. targets vector target population mean values covariate. resulting weights yield sample means within tols units target values covariate. target values NA, corresponding variable targeted weighted mean wherever weights yield smallest variance. ensure weighted mean covariate equal unweighted mean (.e., original mean target mean), original mean must supplied target. factor variables, target value must specified level factor, values must add 1. Can also output call process_targets(). s.weights vector sampling weights. optweight(), can also name variable data contains sampling weights. b.weights vector base weights. supplied, desired norm distance estimated weights base weights minimized. optweight(), can also name variable data contains base weights. norm character; string containing name norm corresponding objective function minimize. Allowable options include \"l1\" \\(L_1\\) norm, \"l2\" \\(L_2\\) norm (default), \"linf\" \\(L_\\infty\\) norm, \"entropy\" relative entropy, \"log\" sum negative logs. See Details. min.w numeric; single value less 1 smallest allowable weight. analyses require nonzero weights units, small, nonzero minimum may desirable. default 1e-8 (\\(10^{-8}\\)), materially change properties weights minimum 0 prevents warnings packages use weights model fitting. norm \"entropy\" \"log\" min.w <= 0, min.w set smallest nonzero value. verbose logical; whether information optimization problem solution printed. Default FALSE. ... optweight(), additional arguments passed optweight.fit(), including options passed settings function corresponding solver. covs numeric matrix covariates targeted. std.binary, std.cont logical; whether tolerances standardized mean units (TRUE) raw units (FALSE) binary variables continuous variables, respectively. default FALSE std.binary raw proportion differences make sense standardized mean difference binary variables. arguments analogous binary continuous arguments cobalt::bal.tab(). solver string; name optimization solver use. Allowable options depend norm. Default use whichever eligible solver installed, , default solver corresponding norm. See Details information.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"optweight.svy(), optweight.svy object following elements: weights estimated weights, one unit. covs covariates used fitting. includes raw covariates, may altered fitting process. s.weights provided sampling weights. call function call. tols tolerance values covariate. duals data.frame containing dual variables covariate. See optweight() interpretation values. info list containing information performance optimization termination. norm norm used. solver solver used. optweight.svy.fit(), optweight.svy.fit object following elements: w estimated weights, one unit. duals data.frame containing dual variables covariate. info list containing information performance optimization termination. norm norm used. solver solver used.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"optweight.svy() primary user-facing function estimating stable balancing weights generalization target population. optimization performed lower-level function optweight.svy.fit(), transforms inputs required inputs optimization functions supplies outputs (weights, dual variables, convergence information) back optweight.svy(). Little processing inputs performed optweight.svy.fit(), normally handled optweight.svy(). Weights estimated standardized differences weighted covariate means corresponding targets within given tolerance thresholds (unless std.binary std.cont FALSE, case unstandardized mean differences considered binary continuous variables, respectively). covariate \\(x\\) specified tolerance \\(\\delta\\), weighted mean within \\(\\delta\\) target. standardized tolerance values requested, standardization factor standard deviation covariate whole sample. standardization factor always unweighted. Target constraints applied product estimated weights sampling weights. addition, sum product estimated weights sampling weights constrained equal sum product base weights sampling weights. See optweight() information norm, solver, convergence failure.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"Jackson, D., Rhodes, K., & Ouwens, M. (2021). Alternative weighting schemes performing matching-adjusted indirect comparisons. Research Synthesis Methods, 12(3), 333–346. doi:10.1002/jrsm.1466","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/optweight.svy.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Stable Balancing Weights for Generalization — optweight.svy","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  cov.names <- c(\"age\", \"educ\", \"race\",                \"married\", \"nodegree\")  targets <- c(age = 23,              educ = 9,              race_black = .3,              race_hispan = .3,              race_white = .4,              married = .2,              nodegree = .5)  ows <- optweight.svy(lalonde[cov.names],                      targets = targets) ows #> An optweight.svy object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - covariates: age, educ, race, married, nodegree  # Unweighted means col_w_mean(lalonde[cov.names]) #>         age        educ  race_black race_hispan  race_white     married  #>  27.3631922  10.2687296   0.3957655   0.1172638   0.4869707   0.4153094  #>    nodegree  #>   0.6302932   # Weighted means; same as targets col_w_mean(lalonde[cov.names],            w = ows$weights) #>         age        educ  race_black race_hispan  race_white     married  #>        23.0         9.0         0.3         0.3         0.4         0.2  #>    nodegree  #>         0.5"},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":null,"dir":"Reference","previous_headings":"","what":"Stable Balancing Weights for Multivariate Treatments — optweightMV","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"Estimates stable balancing weights supplied multivariate (.e., multiple) treatments covariates. degree balance covariate specified tols.list. See Zubizarreta (2015) Wang & Zubizarreta (2020) details properties weights methods used fit .","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"","code":"optweightMV(   formula.list,   data = NULL,   tols.list = list(0),   estimand = \"ATE\",   targets = NULL,   target.tols.list = list(0),   s.weights = NULL,   b.weights = NULL,   norm = \"l2\",   min.w = 1e-08,   verbose = FALSE,   ... )  optweightMV.fit(   covs.list,   treat.list,   tols.list = list(0),   estimand = \"ATE\",   targets = NULL,   target.tols.list = list(0),   s.weights = NULL,   b.weights = NULL,   norm = \"l2\",   std.binary = FALSE,   std.cont = TRUE,   min.w = 1e-08,   verbose = FALSE,   solver = NULL,   ... )"},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"formula.list list formulas, treatment variable left hand side covariates balanced right hand side. data optional data set form data frame contains variables formula.list. tols.list list vectors balance tolerance values covariate treatment. resulting weighted balance statistics least small values. one value supplied, applied covariates. See Details. Default 0 covariates. estimand desired estimand, determines target population. \"ATE\" NULL supported. estimand ignored targets non-NULL. estimand targets NULL, targeting take place. targets optional vector target population mean values covariate. resulting weights ensure midpoint group means within target.tols units target values covariate. NULL NA, estimand used determine targets. Otherwise, estimand ignored. target values NA, corresponding variable targeted weighted mean wherever weights yield smallest value objective function; allowed treatments binary multi-category. Can also output call process_targets(). See Details. target.tols.list list vectors target balance tolerance values covariate treatment. binary multi-category treatments, average pair means far target means values. Can also output call process_tols(). See Details. Default 0 covariates. Ignored continuous treatments. s.weights vector sampling weights. optweightMV(), can also name variable data contains sampling weights. b.weights vector base weights. supplied, desired norm distance estimated weights base weights minimized. optweightMV(), can also name variable data contains base weights. norm character; string containing name norm corresponding objective function minimize. Allowable options include \"l1\" \\(L_1\\) norm, \"l2\" \\(L_2\\) norm (default), \"linf\" \\(L_\\infty\\) norm, \"entropy\" relative entropy, \"log\" sum negative logs. See Details. min.w numeric; single value less 1 smallest allowable weight. analyses require nonzero weights units, small, nonzero minimum may desirable. default 1e-8 (\\(10^{-8}\\)), materially change properties weights minimum 0 prevents warnings packages use weights model fitting. norm \"entropy\" \"log\" min.w <= 0, min.w set smallest nonzero value. verbose logical; whether information optimization problem solution printed. Default FALSE. ... optweightMV(), additional arguments passed optweightMV.fit(), including options passed settings function corresponding solver. covs.list list containing one numeric matrix covariates balanced treatment. treat.list list containing one vector treatment statuses treatment. std.binary, std.cont logical; whether tolerances standardized mean units (TRUE) raw units (FALSE) binary variables continuous variables, respectively. default FALSE std.binary raw proportion differences make sense standardized mean difference binary variables. arguments analogous binary continuous arguments cobalt::bal.tab(). solver string; name optimization solver use. Allowable options depend norm. Default use whichever eligible solver installed, , default solver corresponding norm. See Details information.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"optweightMV(), optweightMV object following elements: weights estimated weights, one unit. treat.list list values treatment variables. covs.list list covariates treatment used fitting. includes raw covariates, may altered fitting process. s.weights provided sampling weights. b.weights provided base weights. call function call. tols list tolerance values covariate treatment. duals list data.frames containing dual variables covariate treatment. See optweight() interpretation values. info list containing information performance optimization termination. norm norm used. solver solver used. optweightMV.fit(), optweightMV.fit object following elements: w estimated weights, one unit. duals data.frame containing dual variables covariate. info list containing information performance optimization termination. norm norm used. solver solver used.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"optweightMV() primary user-facing function estimating stable balancing weights multivariate treatments. optimization performed lower-level function optweightMV.fit(), transforms inputs required inputs optimization functions supplies outputs (weights, dual variables, convergence information) back optweightMV(). Little processing inputs performed optweightMV.fit(), normally handled optweightMV(). See optweight() information balance tolerances (.e., specified tols.list), targets, norm, solver, convergence failure.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"Chattopadhyay, ., Cohn, E. R., & Zubizarreta, J. R. (2024). One-Step Weighting Generalize Transport Treatment Effect Estimates Target Population. American Statistician, 78(3), 280–289. doi:10.1080/00031305.2023.2267598 Källberg, D., & Waernbaum, . (2023). Large Sample Properties Entropy Balancing Estimators Average Causal Effects. Econometrics Statistics. doi:10.1016/j.ecosta.2023.11.004 Wang, Y., & Zubizarreta, J. R. (2020). Minimal dispersion approximately balancing weights: Asymptotic properties practical considerations. Biometrika, 107(1), 93–105. doi:10.1093/biomet/asz050 Zubizarreta, J. R. (2015). Stable Weights Balance Covariates Estimation Incomplete Outcome Data. Journal American Statistical Association, 110(511), 910–922. doi:10.1080/01621459.2015.1023805","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/optweightMV.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Stable Balancing Weights for Multivariate Treatments — optweightMV","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  # Balancing two treatments (ow1 <- optweightMV(list(treat ~ age + educ + race + re74,                          re75 ~ age + educ + race + re74),                     data = lalonde)) #> An optweightMV object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - number of treatments: 2 #>     treat: 2-category #>     re75: continuous #>  - covariates:  #>     + for treat: age, educ, race, re74 #>     + for re75: age, educ, race, re74  summary(ow1) #>                   Summary of weights #> ─────────────────── Treatment 1 ─────────────────── #> - Weight ranges: #>  #>         Min                                 Max #> treated   0 |---------------------------| 8.786 #> control   0 |--------------------|        6.704 #>  #> - Units with the 5 most extreme weights by group: #>                                        #>            179   166   162   124    23 #>  treated 5.682 5.913   6.4 6.819 8.786 #>            300    48    26    19    15 #>  control 3.854 3.955 3.991 5.418 6.704 #>  #>  #> - Weight statistics: #>  #>            L2    L1    L∞ Rel Ent # Zeros #> treated 1.783 1.35  7.786   1.276       0 #> control 0.955 0.743 5.704   0.477       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.    185.   #> Weighted    224.31   44.26 #> ─────────────────── Treatment 2 ─────────────────── #> - Weight ranges: #>  #>     Min                                 Max #> all   0 |---------------------------| 8.786 #>  #> - Units with the 5 most extreme weights: #>                                  #>        200 179   166   124    23 #>  all 5.913 6.4 6.704 6.819 8.786 #>  #>  #> - Weight statistics: #>  #>        L2    L1    L∞ Rel Ent # Zeros #> all 1.263 0.926 7.786   0.718       0 #>  #> - Effective Sample Sizes: #>  #>             Total #> Unweighted 614.   #> Weighted   236.54  bal.tab(ow1) #> Balance by Time Point #>  #>  - - - Time: 1 - - -  #> Balance Measures #>                Type Diff.Adj #> age         Contin.       -0 #> educ        Contin.       -0 #> race_black   Binary       -0 #> race_hispan  Binary        0 #> race_white   Binary        0 #> re74        Contin.       -0 #>  #> Effective sample sizes #>            Control Treated #> Unadjusted  429.    185.   #> Adjusted    224.31   44.26 #>  #>  - - - Time: 2 - - -  #> Balance Measures #>                Type Corr.Adj Diff.Target.Adj #> age         Contin.       -0               0 #> educ        Contin.       -0               0 #> race_black   Binary       -0               0 #> race_hispan  Binary       -0              -0 #> race_white   Binary        0              -0 #> re74        Contin.       -0               0 #>  #> Effective sample sizes #>             Total #> Unadjusted 614.   #> Adjusted   236.54 #>  - - - - - - - - - - -  #>"},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot Dual Variables for Covariate Constraints — plot.optweight","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"Plots dual variables resulting optweight(), optweightMV(), optweight.svy() way similar figure 2 Zubizarreta (2015), explains interpret values.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"","code":"# S3 method for class 'optweight' plot(x, type = \"variables\", ...)  # S3 method for class 'optweightMV' plot(x, which.treat = 1L, type = \"variables\", ...)  # S3 method for class 'optweight.svy' plot(x, type = \"variables\", ...)"},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"x optweight, optweightMV, optweight.svy object; output call optweight(), optweightMV(), optweight.svy(). type type plot display; allowable options include \"variables\" (default), produces row covariate, \"constraints\", produces row type constraint (computed sum absolute dual variables constraint type). ... ignored. .treat optweightMV objects, integer corresponding treatment display. one may displayed time.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"ggplot object can used ggplot2 functions.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"Dual variables represent cost changing constraint objective function minimized estimate weights. covariates large values dual variable, tightening constraint increase variability weights, relaxing constraint decrease variability weights, greater extent covariate small values dual variable. See optweight() vignette(\"optweight\") information interpreting dual variables.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"Zubizarreta, J. R. (2015). Stable Weights Balance Covariates Estimation Incomplete Outcome Data. Journal American Statistical Association, 110(511), 910–922. doi:10.1080/01621459.2015.1023805","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/plot.optweight.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot Dual Variables for Covariate Constraints — plot.optweight","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  tols <- process_tols(treat ~ age + educ + married +                        nodegree + re74, data = lalonde,                      tols = .1)  #Balancing covariates between treatment groups (binary) ow1 <- optweight(treat ~ age + educ + married +                    nodegree + re74, data = lalonde,                  tols = tols,                  estimand = \"ATT\")  # Note the L2 divergence and effective sample # size (ESS) summary(ow1, weight.range = FALSE) #>                   Summary of weights #>  #> - Weight statistics: #>  #>            L2    L1 L∞ Rel Ent # Zeros #> treated 0.    0.     0   0.          0 #> control 0.532 0.462  1   0.181       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.       185 #> Weighted    334.41     185  # age has a low value, married is high plot(ow1)   tols[\"age\"] <- 0 ow2 <- optweight(treat ~ age + educ + married +                    nodegree + re74, data = lalonde,                  tols = tols,                  estimand = \"ATT\")  # Notice that tightening the constraint on age has # a negligible effect on the variability of the # weights and ESS summary(ow2, weight.range = FALSE) #>                   Summary of weights #>  #> - Weight statistics: #>  #>            L2    L1 L∞ Rel Ent # Zeros #> treated 0.    0.     0   0.          0 #> control 0.534 0.465  1   0.183       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.       185 #> Weighted    333.86     185  tols[\"age\"] <- .1 tols[\"married\"] <- 0 ow3 <- optweight(treat ~ age + educ + married +                    nodegree + re74, data = lalonde,                  tols = tols,                  estimand = \"ATT\")  # In contrast, tightening the constraint on married # has a large effect on the variability of the # weights, shrinking the ESS summary(ow3, weight.range = FALSE) #>                   Summary of weights #>  #> - Weight statistics: #>  #>            L2    L1 L∞ Rel Ent # Zeros #> treated 0.    0.     0   0.          0 #> control 0.676 0.647  1   0.277       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.       185 #> Weighted    294.35     185  # More duals are displayed when targeting other # estimands: ow4 <- optweight(treat ~ age + educ + married +                    nodegree + re74, data = lalonde,                  estimand = \"ATE\")  plot(ow4)   # Display duals by constraint type plot(ow4, type = \"constraints\")"},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":null,"dir":"Reference","previous_headings":"","what":"Construct and Check Targets Input — process_targets","title":"Construct and Check Targets Input — process_targets","text":"Checks whether proposed target population means values targets suitable number order submission optweight(), optweightMV(), optweight.svy(), returns object can supplied targets argument functions.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Construct and Check Targets Input — process_targets","text":"","code":"process_targets(formula, data = NULL, targets = NULL, s.weights = NULL)  check.targets(...)  # S3 method for class 'optweight.targets' print(x, digits = 5, ...)"},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Construct and Check Targets Input — process_targets","text":"formula formula nothing left hand side covariates targeted right hand side. Interactions functions covariates allowed. Can omitted, case variables data assumed targeted. data NULL formula data.frame, data replaced formula. data optional data set form data frame contains variables formula. targets vector target population mean values covariate. order corresponding order corresponding variable formula, except interactions, appear lower-order terms. factor variables, target value must specified level factor, values must add 1. NULL, current sample means produced (weighted s.weights). NA, NA vector named covariate names produced. s.weights vector sampling weights. optweight(), can also name variable data contains sampling weights. ... optweight(), additional arguments passed optweight.fit(), including options passed settings function corresponding solver. x optweight.targets object; output call process_targets(). digits many digits print.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Construct and Check Targets Input — process_targets","text":"optweight.targets object, named vector target population mean values, one (expanded) covariate specified formula. used input targets argument optweight(), optweightMV(), optweight.svy().","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Construct and Check Targets Input — process_targets","text":"purpose process_targets() allow users ensure proposed input targets optweight(), optweightMV(), optweight.svy() correct number entries order. especially important factor variables interactions included formula factor variables split several dummies interactions moved end variable list, can cause confusion potential error entering targets values. Factor variables internally split dummy variable level, user must specify target population mean value level factor. must add 1, error displayed . values represent proportion units target population factor level. Interactions (e.g., :b *b formula input) always sent end variable list even specified elsewhere formula. important run process_targets() ensure order proposed targets corresponds represented order covariates used formula. can run process_targets(., targets = NA) see order covariates required without specifying targets.","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/process_targets.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Construct and Check Targets Input — process_targets","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  # Generating targets; means by default targets <- process_targets(~ age + race + married +                              nodegree + re74,                            data = lalonde)  # Notice race is split into three values targets #>  - targets: #>         age  race_black race_hispan  race_white     married    nodegree  #>    27.36319     0.39577     0.11726     0.48697     0.41531     0.63029  #>        re74  #>  4557.54657   # Generating targets; NA by default targets <- process_targets(~ age + race + married +                              nodegree + re74,                            data = lalonde,                            targets = NA) targets #>  - variables: #> \tage   race_black   race_hispan   race_white   married   nodegree   re74  # Can also supply just a dataset covs <- lalonde |>   subset(select = c(age, race, married,                     nodegree, re74))  targets <- process_targets(covs)  targets #>  - targets: #>         age  race_black race_hispan  race_white     married    nodegree  #>    27.36319     0.39577     0.11726     0.48697     0.41531     0.63029  #>        re74  #>  4557.54657"},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":null,"dir":"Reference","previous_headings":"","what":"Construct and Check Tolerance Input — process_tols","title":"Construct and Check Tolerance Input — process_tols","text":"Checks whether proposed tolerance values tols suitable number order submission optweight() optweight.svy(), returns object can supplied tols argument functions.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Construct and Check Tolerance Input — process_tols","text":"","code":"process_tols(formula, data = NULL, tols = 0)  check.tols(...)  # S3 method for class 'optweight.tols' print(x, internal = FALSE, digits = 5, ...)"},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Construct and Check Tolerance Input — process_tols","text":"formula formula covariates balanced right-hand side. Interactions functions covariates allowed. Lists formulas allowed; multiple formulas must checked one time. data optional data set form data frame contains variables formula. tols vector balance tolerance values standardized mean difference units covariate. order corresponding order corresponding variable formula, except interactions, appear lower-order terms. one value supplied, applied covariates. ... ignored. x optweight.tols object; output call process_tols(). internal logical; whether print tolerance values used internally optweight(). See Value section. digits many digits print.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Construct and Check Tolerance Input — process_tols","text":"optweight.tols object, named vector tolerance values, one variable specified formula. used input tols argument optweight(). \"internal.tols\" attribute contains tolerance values used internally optweight(). differ vector values factor variables split ; user needs submit one tolerance per factor variable, separate tolerance values produced new dummy created.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Construct and Check Tolerance Input — process_tols","text":"purpose process_tols() allow users ensure proposed input tols optweight() correct number entries order. especially important factor variables interactions included formula factor variables split several dummies interactions moved end variable list, can cause confusion potential error entering tols values. Factor variables internally split dummy variable level, user needs specify one tolerance value per original variable; process_tols() automatically expands tols input match newly created variables. Interactions (e.g., :b *b formula input) always sent end variable list even specified elsewhere formula. important run process_tols() ensure order proposed tols corresponds represented order covariates used optweight(). can run process_tols() tols input see order covariates required. Note one formula vector tolerance values can assessed time; multiple treatments, formula tolerance vector must entered separately.","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/process_tols.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Construct and Check Tolerance Input — process_tols","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  # Generating tols; 0 by default tols <- process_tols(treat ~ age + educ + married +                        nodegree + re74,                      data = lalonde)  tols #>  - tols: #>      age     educ  married nodegree     re74  #>        0        0        0        0        0   tols <- process_tols(treat ~ age + educ + married +                        nodegree + re74,                      data = lalonde,                      tols = .05)  tols #>  - tols: #>      age     educ  married nodegree     re74  #>     0.05     0.05     0.05     0.05     0.05   # Checking the order of interactions; notice they go # at the end even if specified at the beginning. tols <- process_tols(treat ~ age:educ + married*race +                        nodegree + re74,                      data = lalonde,                      tols = .05)  tols #>  - tols: #>      married         race     nodegree         re74     age:educ married:race  #>         0.05         0.05         0.05         0.05         0.05         0.05   # Internal tolerances for expanded covariates print(tols, internal = TRUE) #>  - tols: #>      married         race     nodegree         re74     age:educ married:race  #>         0.05         0.05         0.05         0.05         0.05         0.05  #>  #>  - tols used internally by optweight: #>             married          race_black         race_hispan          race_white  #>                0.05                0.05                0.05                0.05  #>            nodegree                re74            age:educ  married:race_black  #>                0.05                0.05                0.05                0.05  #> married:race_hispan  married:race_white  #>                0.05                0.05"},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":null,"dir":"Reference","previous_headings":"","what":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"functions summarize weights resulting call optweight(), optweightMV(), optweight.svy(). summary() produces summary statistics distribution weights, including range variability, effective sample size weighted sample (computed using formula McCaffrey, et al., 2004). plot() creates histogram weights.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"","code":"# S3 method for class 'optweight' summary(object, top = 5L, ignore.s.weights = FALSE, weight.range = TRUE, ...)  # S3 method for class 'optweightMV' summary(object, top = 5L, ignore.s.weights = FALSE, weight.range = TRUE, ...)  # S3 method for class 'optweight.svy' summary(object, top = 5L, ignore.s.weights = FALSE, weight.range = TRUE, ...)  # S3 method for class 'summary.optweight' plot(x, ...)"},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"object optweight, optweightMV, optweight.svy object; output call optweight(), optweightMV(), optweight.svy(). top integer; many largest smallest weights display. Default 5. Ignored weight.range = FALSE. ignore.s.weights logical; whether ignore sampling weights computing weight summary. Default FALSE`. weight.range logical; whether display statistics range weights highest lowest weights group. Default TRUE. ... Additional arguments. plot(), additional arguments passed graphics::hist() determine number bins, though ggplot2::geom_histogram() ggplot2 actually used create plot. x summary.optweight, summary.optweightMV, summary.optweight.svy object; output call summary.optweight(), summary.optweightMV(), ()summary.optweight.svy.","code":""},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"point treatments (.e., optweight objects), summary() returns summary.optweight object following elements: weight.range range (minimum maximum) weight treatment group. weight.top units greatest weights treatment group; many included determined top. l2 square root \\(L_2\\) norm estimated weights base weights, weighted sampling weights (): \\(\\sqrt{\\frac{1}{n}\\sum_i {s_i(w_i - b_i)^2}}\\) l1 \\(L_1\\) norm estimated weights base weights, weighted sampling weights (): \\(\\frac{1}{n}\\sum_i {s_i \\vert w_i - b_i \\vert}\\) linf \\(L_\\infty\\) norm (maximum absolute deviation) estimated weights base weights: \\(\\max_i {\\vert w_i - b_i \\vert}\\) rel.ent relative entropy estimated weights base weights, weighted sampling weights (): \\(\\frac{1}{n}\\sum_i {s_i w_i \\log\\left(\\frac{w_i}{b_i}\\right)}\\). computed weights positive. num.zeros number units weight equal 0. effective.sample.size effective sample size treatment group weighting. multivariate treatments (.e., optweightMV objects), list elements treatment. optweight.svy objects, object treatment group divisions. plot() returns ggplot object histogram displaying distribution estimated weights. estimand ATT ATC, weights non-focal group(s) displayed (since weights focal group 1). dotted line displayed mean weights (mean base weights, 1 supplied).","code":""},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"McCaffrey, D. F., Ridgeway, G., & Morral, . R. (2004). Propensity Score Estimation Boosted Regression Evaluating Causal Effects Observational Studies. Psychological Methods, 9(4), 403–425. doi:10.1037/1082-989X.9.4.403","code":""},{"path":[]},{"path":"https://ngreifer.github.io/optweight/reference/summary.optweight.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Summarize, Print, and Plot Information about Estimated Weights — summary.optweight","text":"","code":"library(\"cobalt\") data(\"lalonde\", package = \"cobalt\")  #Balancing covariates between treatment groups (binary) (ow1 <- optweight(treat ~ age + educ + married +                     nodegree + re74, data = lalonde,                   tols = .001,                   estimand = \"ATT\")) #> An optweight object #>  - number of obs.: 614 #>  - norm minimized: \"l2\" #>  - sampling weights: present #>  - base weights: present #>  - treatment: 2-category #>  - estimand: ATT (focal: 1) #>  - covariates: age, educ, married, nodegree, re74  (s <- summary(ow1)) #>                   Summary of weights #> - Weight ranges: #>  #>         Min                                 Max #> treated   1           ||                  1.    #> control   0 |---------------------------| 3.019 #>  #> - Units with the 5 most extreme weights by group: #>                                        #>              1     2     3     4     5 #>  treated     1     1     1     1     1 #>            404   226   224   111    84 #>  control 2.511 2.527 2.626 2.721 3.019 #>  #>  #> - Weight statistics: #>  #>            L2    L1    L∞ Rel Ent # Zeros #> treated 0.    0.    0.       0.         0 #> control 0.783 0.694 2.019    0.39       0 #>  #> - Effective Sample Sizes: #>  #>            Control Treated #> Unweighted  429.       185 #> Weighted    265.88     185  plot(s, breaks = 12)"},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-development-version","dir":"Changelog","previous_headings":"","what":"optweight (development version)","title":"optweight (development version)","text":"Specifying tolerances works slightly differently binary multi-category treatments optweight(). tols controls similar pair groups , new argument, target.tols, controls similar average group means target mean. means group balance separate target balance. See ?optweight information. Previously, tols controlled target balance, group balance came along free. slightly changes weights estimated setting tols value greater 0 target.tols set 0 (default): now, group means must equidistant target means, whereas previously, required group means tols/2 target mean. duals output slightly different: multivariate treatments optweightMV(), duals component output object single data frame new column, component, corresponding treatment dual variable refers . weighting functions, dual variable corresponding constraint minimum weights (controlled min.w) now included output component equal 0. plot.optweight(), new argument, type, can specified select two types dual variable plots: \"variables\", default, displays dual variable covariate; \"constraints\" displays dual variable constraint type (weight range, balance, target), computed sum dual variables constraint type. Moved documentation around; optweight() optweight.fit() now documented page, optweightMV() optweightMV.fit() now documented page, optweight.svy() optweight.svy.fit() now documented page. min.w now visible argument optweight(), optweightMV(), optweight.svy(). collapse now dependency. Messages now little prettier thanks cli, new dependency. Documentation vignette updates.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-100","dir":"Changelog","previous_headings":"","what":"optweight 1.0.0","title":"optweight 1.0.0","text":"CRAN release: 2025-09-09 version involved full rewrite may backward compatible prior versions. Basic functionality changed, advanced functionality changed. Added new function, optweightMV(), performing weighting multivariate treatments. takes place old functionality optweight() take list formulas. Documentation supporting text updated emphasize purpose function multivariate treatments, longitudinal treatments previously documented. Note optweight() now throws error list formulas supplied. lower-level version, optweightMV.fit(), also available. check.tols() check.targets() renamed process_tols() process_targets(), respectively, new functionality. stop argument removed. process_targets() now accepts s.weights compute sampling-weighted target means. norm can set \"entropy\" optweight(), etc., minimizes negative entropy weights. equivalent entropy balancing, implemented efficiently WeightIt, support inexact balance multivariate treatments. norm can also set \"log\" optweight(), etc., minimizes sum negative log weights. equivalent nonparametric covariate balancing propensity score (npCBPS) weighting, version implemented CBPS. implementation support inexact balance multivariate treatments. Negative values now allowed min.w argument. Different solvers can used supplying argument solver. See ?optweight.fit() defaults allowable options. optweight.svy(), process_tols(), process_targets() can supplied without formula, uses variables supplied data. Documentation now roxygen2. Added new vignette (vignette(\"optweight\")). Added b.weights argument supply base weights. supplied, rather minimizing variance weights, squared distance base weight minimized, mirroring functionality base.weights argument ebalance entropy balancing. norms now support base weights. Omitting base weights equivalent setting equal 1. Optimization proceeds differently s.weights supplied. First, \\(L_\\infty\\) used sampling weights. Second, norm minimized weighted norm difference estimated weights base weights, estimated weights incorporating sampling weights. , \\(L_2\\) norm minimizes \\(\\sum_i s_i(w_i-b_i)^2\\), \\(L_1\\) norm minimizes \\(\\sum_i s_i|w_i-b_i|\\), \\(s_i\\) sampling weight unit \\(\\), \\(b_i\\) base weight (1 default), \\(w_i\\) weights estimated. weights used balance constraints (ultimately effect estimation) \\(w^*_i=s_i w_i\\). implication ESS \\(w^*_i\\) maximized \\(L_2\\) norm. also ensures weighted bootstrap correctly accounts estimation weights. summary() now displays \\(L_2\\), \\(L_1\\), \\(L_\\infty\\) norms relative entropy estimated weights base weights, number weights estimated 0. \\(L_2\\) \\(L_1\\) norms relative entropy weighted s.weights present. polish now TRUE default norms \"entropy\"; slightly improves estimation. default arguments solvers changed. Formula interfaces now accept poly(x, .) matrix-generating functions variables, including rms-class-generating functions rms package (e.g., pol(), rcs(), etc.) (rms package must loaded use latter ones) basis-class-generating functions splines package (.e., bs() ns()). bug early version found @ahinton-mmc. returned covariates now without transformations. Updated README. Added new logo.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-025","dir":"Changelog","previous_headings":"","what":"optweight 0.2.5","title":"optweight 0.2.5","text":"CRAN release: 2019-09-16 Reverting back using osqp instead rosqp now osqp works. cobalt back.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-024","dir":"Changelog","previous_headings":"","what":"optweight 0.2.4","title":"optweight 0.2.4","text":"CRAN release: 2019-09-03 Reverting back using rosqp instead osqp due package failure. Also removed reliance cobalt favor MatchIt data. changes temporary.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-023","dir":"Changelog","previous_headings":"","what":"optweight 0.2.3","title":"optweight 0.2.3","text":"CRAN release: 2019-08-25 rosqp package now osqp, faster fewer bugs. focal set, estimand automatically changed \"ATT\". past, focal ignored unless estimand = \"ATT\". Fixed bugs processing formula inputs. particular, functions can used inside lapply() loops nested functions gracefully. bugs fixes small changes.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-022","dir":"Changelog","previous_headings":"","what":"optweight 0.2.2","title":"optweight 0.2.2","text":"CRAN release: 2019-03-04 Fixed bug duals displaying improperly factor variables present.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-021","dir":"Changelog","previous_headings":"","what":"optweight 0.2.1","title":"optweight 0.2.1","text":"CRAN release: 2019-01-16 Changed default min.w optweight.fit() optweight.svy.fit() 1E-8 0. ensures weights nonzero, can reduce bugs functions require nonzero weights (e.g, jtools::summ() survey::svyglm()). Fixed warning occur interactions present model formula optweight(). Stable balancing weights discovered invalid longitudinal treatments, attempting use optweight()optweight.fit() longitudinal treatments now produce error. can overridden setting force = TRUE, though recommended research done.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-020","dir":"Changelog","previous_headings":"","what":"optweight 0.2.0","title":"optweight 0.2.0","text":"CRAN release: 2018-10-17 Added optweight.svy() associated methods functions estimating survey weights using optimization. weights applied sample yield sample whose covariate means equal (within specified tolerance) given target values. Minor changes check.targets(). now produce covariate means targets argument empty produce previous empty output, named vector NAs, targets = NULL. Changes dual variables processed displayed. Now, dual variable coming optweight() represents change objective function corresponding 1-unit change tols. reported duals sum duals affected constraint, can now reliably predict change objective function change tols (obscured error-prone previously). distinction targeting duals balance duals maintained.","code":""},{"path":"https://ngreifer.github.io/optweight/news/index.html","id":"optweight-010","dir":"Changelog","previous_headings":"","what":"optweight 0.1.0","title":"optweight 0.1.0","text":"CRAN release: 2018-09-21 First version!","code":""}]
